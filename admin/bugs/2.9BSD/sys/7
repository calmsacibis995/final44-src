From BBB4D%DHVRRZ01.BITNET@wiscvm.wisc.edu  Tue Nov 19 08:59:06 1985
Date:    TUE NOV 19 1985  14:17:38 MEZ
From: BBB4D%DHVRRZ01.BITNET@wiscvm.wisc.edu
Subject: MESSAGE FROM HARALD SCHAEFER     +49 511 762 5138
Index: sys/sys1.c 2.9BSD

SUBJECT:
        SYSTEM-CRASHES AND CORE-DUMPS OF USER-PROGRAMS IF EXECUTING
        SHELL-SCRIPTS WHILE THE SYSTEM IS SWAPPING.

DESCRIPTION:
        IF YOU WANT TO EXECUTED A SHELL-SCRIPT, THE SHELL FIRST TRY TO
        EXECUTE IT AS A CORE-IMAGE (E.G. WITH MAGIC NUMBER 0407). WHEN
        THIS SYSTEM CALL FAILS, A SUB-SHELL IS INVOKED TO INTERPRET THE
        COMMAND-FILE.
        THE ARGUMENTS FOR THIS SCRIPT ARE COLLECTED ON A SPACE IN THE
        SWAP-AREA, WITH THE DELWRI-BIT SET (TO DELAY OR EVEN SPARE THE
        WRITE-OUT OF THE BLOCK).
        IF THE EXEC-CALL IS SUCCESSFUL, THE ARGUMENTS ARE READ-IN,
        OTHERWISE THERE IS A LOOP IN VERSION 7, WHICH RESETS THE DELWRI
        FLAG FOR THESE BLOCKS, BEFORE THEY ARE RELEASED BY A CALL TO
        MFREE.
        NOW YOU HAVE MADE A CHANGE TO THE ORIGINAL VERSION 7, PERHAPS
        FOR SAVING TIME: YOU HAVE OMITTED THIS LOOP IN THE EXEC-CALL AT
        ABOUT LINE 245, BUT THIS HAS FATAL CONSEQUENCES.
        THE SPACE IN THE SWAP-AREA MAY BE REALLOCATED FOR A PROCESS,
        WHICH IS TO BE SWAPPED OUT, WHILE THERE ARE STILL BLOCKS WITH
        THE DELWRI-BIT FOR THIS AREA, WHICH WILL BE WRITTEN OUT E.G.
        AT A SYNC AND THUS DESTROY THE SWAPPED OUT PROGRAM.
        IF THIS PROGRAM IS RELOADED, IT WILL TERMINATED ABNORMALLY OR
        EVEN CAUSE A SYSTEM-CRASH, IF ITS USER-AREA IS OVERWRITTEN.
REPEAT-BY:
RUN A SHELL-SCRIPT LIKE
           WHILE TRUE
              DO
                 <ANOTHER SHELL-SCRIPT>
              DONE
        AND START IN PARALLEL SOME PROCESSES LIKE LINT OR NROFF, WHICH
        CAUSES SWAPPING, AND YOU WILL HAVE SOME CORE-DUMPS OR ANYTHING
        OTHER IRREGULAR.
FIX:
YOU HAVE TO REINSTALL THE LOOP OVER ALL BLOCKS NEEDED FOR THE
        ARGUMENTS, WHICH FIND THE BLOCK WITH GETBLK AND RESETS THE
        DELWRI-BIT, BEFORE THE CALL TO MFREE.
        ACTUALLY A CALL TO GETBLK WRITE OUT THE BLOCK, WHICH IS NOT
        NEEDED AND SO THIS SOLUTION WASTES TIME, BUT IT IS SAVE.
REMARK:
        THIS IS MY FIRST MESSAGE TO 2BSD-BUGS AND I WOULD BE PLEASED
        TO GET AN ANSWER OF YOU TO SEE THAT THE CONNECTION VIA ARPANET
        IS O.K. . I WILL SEND YOU THEN SOME MORE BUGS.
        OUR HOST-COMPUTER IN HANNOVER HAS PROBLEMS WITH LOWER CASE LETTERS
        SO I CAN ONLY SEND NOTES IN UPPER CASE, BUT I HOPE, YOU CAN READ
        IT.
