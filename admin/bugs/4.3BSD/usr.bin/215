From leres@helios.ee.lbl.gov  Mon Oct  9 23:16:36 1989
To: bugs@okeeffe.Berkeley.EDU (Bugs BSD Bunny)
Subject: fast find database bug
Index: usr.bin/find/code.c 4.3BSD +FIX
Date: Mon, 09 Oct 89 23:16:31 PDT
From: Craig Leres <leres@helios.ee.lbl.gov>

Description:
	The fast find "sorted list compressor" is broken.

Repeat-By:
	Use a database generated by it and note the annoying q-marks at
	the end of each line:

	    okeeffe 13 % find xterm.ic
	    /b/guest/leres/sun/icons/xterm.ic?

Fix:
	Code was broken during its conversion from gets() to fgets().
	When using the latter, it's necessary to strip the trailing
	newline. (While we're at it, let's also fix a questionable
	unsigned comparison.)

*** code.c	Fri May 19 19:10:23 1989
--- code.c.new	Mon Oct  9 23:12:54 1989
***************
*** 1,3 ****
--- 1,7 ----
+ #ifndef lint
+ static char rcsid[] =
+     "@(#) $Header: code.c,v 1.2 89/10/09 23:02:54 leres Exp $ (LBL)";
+ #endif
  /*
   * Copyright (c) 1989 The Regents of the University of California.
   * All rights reserved.
***************
*** 25,31 ****
  #endif /* not lint */
  
  #ifndef lint
! static char sccsid[] = "@(#)code.c	4.5 (Berkeley) 5/19/89";
  #endif /* not lint */
  
  /*
--- 29,35 ----
  #endif /* not lint */
  
  #ifndef lint
! static char sccsid[] = "@(#)code.c	4.5++ (Berkeley) 5/19/89";
  #endif /* not lint */
  
  /*
***************
*** 90,98 ****
  	fclose( fp );
  
       	while ( fgets ( path, sizeof(buf2), stdin ) != NULL ) {
  		/* squelch characters that would botch the decoding */
  		for ( cp = path; *cp != NULL; cp++ ) {
! 			if ( *cp >= PARITY )
  				*cp &= PARITY-1;
  			else if ( *cp <= SWITCH )
  				*cp = '?';
--- 94,106 ----
  	fclose( fp );
  
       	while ( fgets ( path, sizeof(buf2), stdin ) != NULL ) {
+ 		/* truncate newline */
+ 		cp = path + strlen(path) - 1;
+ 		if (cp > path && *cp == '\n')
+ 			*cp = '\0';
  		/* squelch characters that would botch the decoding */
  		for ( cp = path; *cp != NULL; cp++ ) {
! 			if ( (unsigned char)*cp >= PARITY )
  				*cp &= PARITY-1;
  			else if ( *cp <= SWITCH )
  				*cp = '?';
