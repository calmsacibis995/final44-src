h36837
s 00008/00003/01972
d D 8.2 94/06/01 19:45:30 ah 36 35
c page breaks for 4.4BSD manuals
e
s 00000/00000/01974
d D 8.1 93/07/27 18:59:00 mckusick 35 34
c 4.4BSD snapshot (revision 8.1)
e
s 00005/00005/01969
d D 6.31 93/07/27 18:57:04 mckusick 34 33
c grammer, naming
e
s 00011/00011/01963
d D 6.30 93/07/27 18:01:56 mckusick 33 32
c spelling and grammar nits of Keith's additions
e
s 00175/00164/01799
d D 6.29 93/07/27 12:08:13 bostic 32 31
c list some of the utility changes
e
s 00001/00003/01962
d D 6.28 93/07/21 18:36:46 mckusick 31 30
c do not have .Op macro
e
s 00028/00029/01937
d D 6.27 93/07/21 18:29:39 mckusick 30 29
c typesetting, diction, other random nits
e
s 00059/00063/01907
d D 6.26 93/07/20 16:02:46 bostic 29 28
c break the timezone stuff out into the library area
e
s 00136/00004/01834
d D 6.25 93/07/20 15:34:12 bostic 28 27
c add some words on library andutilities changes
e
s 00068/00059/01770
d D 6.24 93/07/20 12:16:21 mckusick 27 26
c final edit pass
e
s 00026/00014/01803
d D 6.23 93/07/16 08:48:05 hibler 26 25
c move the "locate" paragraph into the utilities changes section, 
c added a paragraph on find "fstype" and "prune" options
e
s 00002/00002/01815
d D 6.22 93/07/15 16:46:15 mckusick 25 24
c get rid of last of the .IR's
e
s 00048/00049/01769
d D 6.21 93/07/15 16:38:14 mckusick 24 23
c spelling and diction
e
s 00042/00000/01776
d D 6.20 93/07/15 14:17:00 mckusick 23 22
c add info about nodump flag, new directory format, short symbolic links
e
s 00007/00007/01769
d D 6.19 93/07/15 14:05:45 hibler 22 21
c spelling
e
s 00093/00010/01683
d D 6.18 93/07/15 10:45:50 hibler 21 20
c expound on the VM, talk about 4.3 on the hp300, cleanup
e
s 00000/00000/01693
d D 6.17 93/07/14 12:49:36 hibler 20 19
c expand on the VM section a little
e
s 00001/00001/01692
d D 6.16 93/07/13 16:41:38 mckusick 19 18
c section 4.2 moves to 2.5 as disk layout needs to be dealt with earlier
e
s 00040/00009/01653
d D 6.15 93/07/13 16:13:34 hibler 18 16
c added section on native os compatibility
e
s 00000/00000/01662
d R 6.15 93/07/13 14:40:05 hibler 17 16
c add a section on "native OS compatibility" and clean up some
e
s 00006/00007/01656
d D 6.14 93/07/12 22:42:46 mckusick 16 15
c nits discovered from reading
e
s 00102/00009/01561
d D 6.13 93/07/12 21:38:11 mckusick 15 14
c add description of new filesystem layout; fix nits
e
s 00556/00287/01014
d D 6.12 93/07/12 20:10:47 mckusick 14 13
c comments from Bostic; add bug fixes and changes section;
c incorporate parts of dear collegue letter
e
s 00008/00004/01293
d D 6.11 93/07/09 21:36:10 mckusick 13 12
c proofreading corrections (I've been looking at this document too long!)
e
s 00098/00054/01199
d D 6.10 93/07/09 20:47:46 mckusick 12 11
c typesetting nits
e
s 01013/00451/00240
d D 6.9 93/07/09 00:32:10 mckusick 11 9
c first pass at getting updated for 4.4BSD
e
s 00002/00002/00689
d R 8.1 93/06/08 13:56:47 bostic 10 9
c 4.4BSD snapshot (revision 8.1); add 1993 to copyright
e
s 00002/00012/00689
d D 6.8 91/04/17 11:32:55 bostic 9 8
c new copyright; att/bsd/shared
e
s 00014/00003/00687
d D 6.7 89/03/07 13:20:23 bostic 8 7
c add Berkeley specific copyright, networking release
e
s 00012/00004/00678
d D 6.6 88/07/21 18:05:53 bostic 7 6
c add warning about sendmail; minor cleanup
e
s 00254/00094/00428
d D 6.5 88/07/17 09:33:55 karels 6 5
c merge vax and tahoe versions
e
s 00052/00008/00470
d D 6.4 88/07/08 14:49:04 mckusick 5 4
c update error messages from fsckk
e
s 00002/00002/00476
d D 6.3 88/01/25 16:03:10 bostic 4 3
c minor comment
e
s 00001/00001/00477
d D 6.2 87/09/28 14:44:16 bostic 3 2
c R. Adams; change chown root to chown uucp for uucp directory
e
s 00416/00156/00062
d D 6.1 86/05/14 09:35:26 mckusick 2 1
c 4.3BSD release document
e
s 00218/00000/00000
d D 5.1 86/05/14 09:35:16 mckusick 1 0
c broken out of 0.t for 4.2BSD document
e
u
U
t
T
I 1
D 6
.\" Copyright (c) 1980 Regents of the University of California.
E 6
I 6
D 8
.\" Copyright (c) 1980,1986,1988 Regents of the University of California.
E 6
.\" All rights reserved.  The Berkeley software License Agreement
.\" specifies the terms and conditions for redistribution.
E 8
I 8
D 9
.\" Copyright (c) 1980, 1986, 1988 Regents of the University of California.
E 9
I 9
D 11
.\" Copyright (c) 1980, 1986, 1988 The Regents of the University of California.
E 9
.\" All rights reserved.
E 11
I 11
D 32
.\" Copyright (c) 1980, 1986, 1988, 1993
E 32
I 32
D 33
\" Copyright (c) 1980, 1986, 1988, 1993
E 33
I 33
.\" Copyright (c) 1980, 1986, 1988, 1993
E 33
E 32
.\"	 The Regents of the University of California.  All rights reserved.
E 11
.\"
D 9
.\" Redistribution and use in source and binary forms are permitted
.\" provided that the above copyright notice and this paragraph are
.\" duplicated in all such forms and that any documentation,
.\" advertising materials, and other materials related to such
.\" distribution and use acknowledge that the software was developed
.\" by the University of California, Berkeley.  The name of the
.\" University may not be used to endorse or promote products derived
.\" from this software without specific prior written permission.
.\" THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR
.\" IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED
.\" WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.
E 9
I 9
.\" %sccs.include.redist.roff%
E 9
E 8
.\"
.\"	%W% (Berkeley) %G%
.\"
.ds lq ``
.ds rq ''
D 2
.ds LH "Installing/Operating 4.2BSD
.ds RH "Upgrading a 4BSD system
E 2
I 2
D 6
.ds LH "Installing/Operating \*(4B
.ds RH "Upgrading a 4.2BSD System
E 6
I 6
D 11
.ds RH "Upgrading a 4.2BSD or \*(Ps System
E 6
E 2
.ds CF \*(DY
.LP
.nr H1 3
.nr H2 0
.bp
.LG
.B
.ce
D 2
3. UPGRADING A 4BSD SYSTEM
E 2
I 2
D 6
3. UPGRADING A 4.2BSD SYSTEM
E 6
I 6
3. UPGRADING A 4.2BSD OR \*(Ps SYSTEM
E 6
E 2
.sp 2
.R
.NL
E 11
I 11
.ds RH "Upgrading a \*(Ps System
.ds CF \*(Dy
D 32
.NH 1
Upgrading a \*(Ps System
E 32
I 32
D 33
.Sh 1 "Upgrading a \*(Ps System"
E 33
I 33
.Sh 1 "Upgrading a \*(Ps system"
E 33
E 32
E 11
.PP
D 2
Begin by reading the other parts of this document to see what
has changed since the last time you bootstrapped the system.
Also read the ``Changes in 4.2BSD'' document, and look
at the new manual sections provided to you.
E 2
I 2
D 6
Begin by reading the ``Bugs Fixes and Changes in \*(4B'' document to
E 6
I 6
D 11
This section describes the procedure for upgrading a 4.2 or \*(Ps
E 11
I 11
This section describes the procedure for upgrading a \*(Ps
E 11
system to \*(4B.  This procedure may vary according to the version of
the system running before conversion.
D 11
If you are upgrading from 4.2BSD,
begin by reading the ``Bugs Fixes and Changes in \*(4B'' document to
E 6
see what has changed since the last time you bootstrapped the system.
E 2
If you have local system modifications to the
D 2
kernel to install, look at the
document ``Kernel changes in 4.2BSD'' to get an idea of how
the system changes will affect your local mods.
E 2
I 2
kernel to install, look at the document
``Changes to the Kernel in \*(4B'' to get an idea of how
the system changes will affect your local modifications.
I 6
.if \n(Th \{\
E 11
If you are converting from a
System V system, some of this section will still apply (in particular,
the filesystem conversion).  However, many of the system configuration
files are different, and the executable file formats are completely
incompatible.
I 21
.PP
In particular be wary when using this information to upgrade
D 30
a 4.3\*(Bs HP300 system.
There are at least 4 different versions of ``4.3'' out there:
E 30
I 30
a \*(Ps HP300 system.
D 34
There are at least 4 different versions of ``\*(Ps'' out there:
E 34
I 34
There are at least four different versions of ``\*(Ps'' out there:
E 34
E 30
.IP 1)
HPBSD 1.x from Utah.
.br
D 30
This was the original version of 4.3\*(Bs for HP300s from which the
D 22
other varients (and 4.4) are derived.
E 22
I 22
other variants (and 4.4) are derived.
E 22
It is largely a 4.3 system with Sun's NFS 3.0 filesystem code and
some 4.3-Tahoe features (e.g. networking code).
E 30
I 30
This was the original version of \*(Ps for HP300s from which the
other variants (and \*(4B) are derived.
It is largely a \*(Ps system with Sun's NFS 3.0 filesystem code and
some \*(Ps-Tahoe features (e.g. networking code).
E 30
Since the filesystem code is 4.2/4.3 vintage and the filesystem
D 30
hierarchy is largely 4.3, most of this section should apply.
E 30
I 30
hierarchy is largely \*(Ps, most of this section should apply.
E 30
.IP 2)
MORE/bsd from Mt. Xinu.
.br
D 30
This is a 4.3-Tahoe vintage system with Sun's NFS 4.0 filesystem code
E 30
I 30
This is a \*(Ps-Tahoe vintage system with Sun's NFS 4.0 filesystem code
E 30
upgraded with Tahoe UFS features.
D 30
The instructions for 4.3-Tahoe should largely apply.
E 30
I 30
The instructions for \*(Ps-Tahoe should largely apply.
E 30
.IP 3)
D 30
4.3-Reno from CSRG.
E 30
I 30
\*(Ps-Reno from CSRG.
E 30
.br
At least one site bootstrapped HP300 support from the Reno distribution.
D 30
The Reno filesystem code was somewhere between 4.3 and 4.4: the VFS switch
E 30
I 30
The Reno filesystem code was somewhere between \*(Ps and \*(4B: the VFS switch
E 30
had been added but many of the UFS features (e.g. ``inline'' symlinks)
were missing.
D 22
The filesystem hierarchy reorginization first appeared in this release.
E 22
I 22
The filesystem hierarchy reorganization first appeared in this release.
E 22
D 24
Be extremely careful following these instructions in this case.
E 24
I 24
Be extremely careful following these instructions if you are
upgrading from the Reno distribution.
E 24
.IP 4)
HPBSD 2.0 from Utah.
.br
D 34
As if things weren't bad enough already,
E 34
I 34
As if things were not bad enough already,
E 34
D 30
this release has the 4.4 filesystem and networking code
as well as some utilities, but still has a 4.3 hierarchy.
E 30
I 30
this release has the \*(4B filesystem and networking code
as well as some utilities, but still has a \*(Ps hierarchy.
E 30
D 24
No filesystem conversions are necessary in this case,
E 24
I 24
No filesystem conversions are necessary for this upgrade,
E 24
but files will still need to be moved around.
E 21
D 11
.\}
E 11
I 11
D 32
.NH 2
Installation overview
E 32
I 32
.Sh 2 "Installation overview"
E 32
E 11
E 6
E 2
.PP
D 2
If you are running a version of the system distributed
prior to 4.0BSD, you are pretty much on your own.  Sites running
3BSD or 32/V may be able to modify the restor program to understand
the old 512 byte block file system, but this has never been
tried.  This section assumes you are running 4.1BSD. 
E 2
I 2
D 6
If you are running 4.2BSD, upgrading your system
E 6
I 6
D 11
If you are running 4.2BSD or \*(Ps, upgrading your system
E 11
I 11
If you are running \*(Ps, upgrading your system
E 11
E 6
involves replacing your kernel and system utilities.
D 6
Binaries compiled under 4.2BSD will work without recompilation
under \*(4B, though they may run faster if they are relinked.
The easiest way to convert to \*(4B
(depending on your file system configuration)
is to create new root and /usr file systems from the
distribution tape on unused disk partitions,
boot the new system, and then copy
any local utilities from your old root and /usr
file systems into the new ones.
All user file systems and binaries can be retained unmodified,
except that the new \fIfsck\fP should be run
before they are mounted (see below).
E 6
I 6
D 11
Binaries compiled under \*(Ps will work without recompilation
under \*(4B, though they may run faster if they are recompiled.
.if \n(Th \{\
When converting from 4.2BSD, most local programs will have to be recompiled,
as there are a number of incompatibilities between 4.3BSD
and the vendor-supplied 4.2BSD.
.\}
.if \n(Vx \{\
Binaries compiled under 4.2BSD will probably work without recompilation,
but it is a good idea to recompile and relink because of the many changes
in header files and libraries since 4.2BSD.
E 6
4.1BSD binary images can also run unchanged under \*(4B
but only when the system is configured to include the
``4.1BSD compatibility mode.''*
.FS
* With ``4.1BSD compatibility mode''
system calls from 4.1BSD are either emulated or safely ignored.
D 6
There are only two exceptions; programs that read directories or use
E 6
I 6
There are only two exceptions: programs that read directories or use
E 6
the old jobs library will not operate properly.  However, while 4.1BSD
binaries will execute under \*(4B
it is \fBSTRONGLY RECOMMENDED\fP that the programs be recompiled under
the new system.
.FE
I 6
.\}
E 11
I 11
In general, there are three possible ways to install a new \*(Bs distribution:
(1) boot directly from the distribution tape, use it to load new binaries
onto empty disks, and then merge or restore any existing configuration files
and filesystems;
(2) use an existing \*(Ps or later system to extract the root and
.Pn /usr
filesystems from the distribution tape,
boot from the new system, then merge or restore existing
configuration files and filesystems; or
(3) extract the sources from the distribution tape onto an existing system,
and use that system to cross-compile and install \*(4B.
D 24
For this release, the second alternative is strongly advised if at all possible,
E 24
I 24
For this release, the second alternative is strongly advised,
E 24
with the third alternative reserved as a last resort.
In general, older binaries will continue to run under \*(4B,
but there are many exceptions that are on the critical path
for getting the system running.
Ideally, the new system binaries (root and
.Pn /usr
filesystems) should be installed on spare disk partitions,
then site-specific files should be merged into them.
Once the new system is up and fully merged, the previous root and
.Pn /usr
filesystems can be reused.
Other existing filesystems can be retained and used,
D 12
except that (as usual) the new \fIfsck\fP should be run
before they are mounted.
E 12
I 12
except that (as usual) the new
.Xr fsck
should be run before they are mounted.
E 12
E 11
E 6
.PP
I 6
D 11
The easiest upgrade path from 4.2BSD or \*(Ps
(depending on your file system configuration)
is to build
new root and \fI/usr\fP file systems on unused partitions,
then copy or merge site specific files
into their corresponding files on the new system.
All user file systems can be retained unmodified,
except that the new \fIfsck\fP should be run
before they are mounted (see below).
E 11
I 11
It is \fBSTRONGLY\fP advised that you make full dumps of each filesystem
before beginning, especially any that you intend to modify in place
during the merge.
It is also desirable to run filesystem checks
of all filesystems to be converted to \*(4B before shutting down.
This is an excellent time to review your disk configuration
for possible tuning of the layout.
Most systems will need to provide a new filesystem for system use
mounted on
.Pn /var
(see below).
However, the
.Pn /tmp
filesystem can be an MFS virtual-memory-resident filesystem,
potentially freeing an existing disk partition.
(Additional swap space may be desirable as a consequence.)
See
D 34
.Xr mfs (8).
E 34
I 34
.Xr mount_mfs (8).
E 34
E 11
.PP
E 6
D 11
Section 3.1 lists the files to be saved as part of the conversion process.
Section 3.2 describes the bootstrap process.
Section 3.3 discusses the merger of the saved files back into the new system.
Section 3.4 provides general hints on possible problems to be
aware of when converting from 4.2BSD to \*(4B.
E 11
I 11
The recommended installation procedure includes the following steps.
The order of these steps will probably vary according to local needs.
.IP \(bu
Extract root and
.Pn /usr
filesystems from the distribution tapes.
.IP \(bu
Extract kernel and/or user-level sources from the distribution tape
if space permits.
This can serve as the backup documentation as needed.
.IP \(bu
Configure and boot a kernel for the local system.
This can be delayed if the generic kernel from the distribution
D 24
supports sufficient hardware to proceed.
E 24
I 24
supports enough hardware to proceed.
E 24
.IP \(bu
Build a skeletal
.Pn /var
filesystem (see
.Xr mtree (8)).
.IP \(bu
Merge site-dependent configuration files from
.Pn /etc
and
.Pn /usr/lib
into the new
.Pn /etc
directory.
Note that many file formats and contents have changed; see section 3.4
of this document.
.IP \(bu
Copy or merge files from
.Pn /usr/adm ,
.Pn /usr/spool ,
.Pn /usr/preserve ,
.Pn /usr/lib ,
and other locations into
.Pn /var .
.IP \(bu
Merge local macros, dictionaries, etc. into
.Pn /usr/share .
.IP \(bu
Merge and update local software to reflect the system changes.
.IP \(bu
Take off the rest of the morning, you've earned it!
.PP
Section 3.2 lists the files to be saved as part of the conversion process.
Section 3.3 describes the bootstrap process.
Section 3.4 discusses the merger of the saved files back into the new system.
D 14
Section 3.5 provides general hints on possible problems to be
E 14
I 14
Section 3.5 gives an overview of the major
D 15
bug fixes and changes between \(*Ps and \*(4B.
E 15
I 15
bug fixes and changes between \*(Ps and \*(4B.
E 15
Section 3.6 provides general hints on possible problems to be
E 14
aware of when converting from \*(Ps to \*(4B.
E 11
E 2
D 32
.NH 2
D 2
Step 1: what to save
E 2
I 2
Files to save
E 32
I 32
.Sh 2 "Files to save"
E 32
E 2
.PP
D 2
No matter what version of the system you may be running, you will
have to rebuild your root and usr file systems.  The easist way
to do this is to save the important files on your existing system,
perform a bootstrap as if you were installing 4.2BSD on a brand new
machine, then merge the saved files into the new system.  The following
list enumerates the standard set of files you will want to save and
indicates directories in which site specific files should be present.
E 2
I 2
D 6
The easiest upgrade path from a 4.2BSD is to build
new root and \fIusr\fP file systems on unused partitions,
then copy or merge site specific files
into their corresponding files on the new system.
E 6
The following list enumerates the standard set of files you will want to
D 6
save and suggests directories in which site specific files should be present.
E 6
I 6
save and suggests directories in which site-specific files should be present.
E 6
E 2
This list will likely be augmented with non-standard files you
D 2
have added to your system;  be sure to do a tar of the
directories /etc, /lib, and /usr/lib to guard against your missing
something the first time around.
E 2
I 2
have added to your system.
If you do not have enough space to create parallel
D 11
file systems, you should create a \fItar\fP image of the
following files before the new file systems are created.
D 6
In addition, you should do a full dump before rebuilding the file system
to guard against missing something the first time around.
E 6
I 6
In addition, it is
\fBSTRONGLY\fP advised that you do a full dump before rebuilding the file
system to guard against missing something the first time around.
E 6
E 2
.DS
E 11
I 11
D 12
filesystems, you should create a \fItar\fP image of the
following files before the new filesystems are created.
E 12
I 12
filesystems, you should create a
.Xr tar
image of the following files before the new filesystems are created.
E 12
The rest of this subsection describes where theses files
have moved and how they have changed.
E 11
.TS
D 2
l l.
/.profile	root sh startup script
/.login	root csh startup script
/.cshrc	root csh startup script
/dev/MAKE	for the LOCAL case for making devices
/etc/fstab	disk configuration data
/etc/group	group data base
/etc/passwd	user data base
/etc/rc	for any local additions
/etc/ttys	terminal line configuration data
/etc/ttytype	terminal line to terminal type mapping data
/etc/termcap	for any local entries which may have been added
/lib	for any locally developed language processors
/usr/dict/*	for local additions to words and papers
/usr/include/*	for local additions
/usr/lib/aliases	mail forwarding data base
/usr/lib/crontab	cron daemon data base
/usr/lib/font/*	for locally developed font libraries
/usr/lib/lint/*	for locally developed lint libraries
/usr/lib/tabset/*	for locally developed tab setting files
/usr/lib/term/*	for locally developed nroff drive tables
/usr/lib/tmac/*	for locally developed troff/nroff macros
/usr/lib/uucp/*	for local uucp configuration files
/usr/man/manl	for manual pages for locally developed programs
/usr/msgs	for current msgs
/usr/spool/*	for current mail, news, uucp files, etc.
/usr/src/local	for source for locally developed programs
E 2
I 2
D 15
l c l.
E 15
I 15
lfC c l.
E 15
D 11
/.cshrc	\(dg	root csh startup script
/.login	\(dg	root csh login script
/.profile	\(dg	root sh startup script
/.rhosts	\(dg	for trusted machines and users
/dev/MAKEDEV	\(dd	in case you added anything here
/dev/MAKEDEV.local	*	for making local devices
E 11
I 11
/.cshrc	\(dg	root csh startup script (moves to \f(CW/root/.cshrc\fP)
/.login	\(dg	root csh login script (moves to \f(CW/root/.login\fP)
/.profile	\(dg	root sh startup script (moves to \f(CW/root/.profile\fP)
/.rhosts	\(dg	for trusted machines and users (moves to \f(CW/root/.rhosts\fP)
E 11
/etc/disktab	\(dd	in case you changed disk partition sizes
D 11
/etc/fstab	\(dg	disk configuration data
E 11
I 11
/etc/fstab	*	disk configuration data
E 11
/etc/ftpusers	\(dg	for local additions
D 11
/etc/gateways	\(dg	routing daemon database
E 11
/etc/gettytab	\(dd	getty database
/etc/group	*	group data base
/etc/hosts	\(dg	for local host information
/etc/hosts.equiv	\(dg	for local host equivalence information
I 14
/etc/hosts.lpd	\(dg	printer access file
E 14
I 11
/etc/inetd.conf	*	Internet services configuration data
I 14
/etc/named*	\(dg	named configuration files
/etc/netstart	\(dg	network initialization
E 14
E 11
/etc/networks	\(dg	for local network information
/etc/passwd	*	user data base
D 11
/etc/printcap	\(dg	line printer database
E 11
I 11
/etc/printcap	*	line printer database
E 11
/etc/protocols	\(dd	in case you added any local protocols
/etc/rc	*	for any local additions
/etc/rc.local	*	site specific system startup commands
/etc/remote	\(dg	auto-dialer configuration
/etc/services	\(dd	for local additions
I 14
/etc/shells	\(dd	list of valid shells
E 14
/etc/syslog.conf	*	system logger configuration
D 11
/etc/securettys	*	for restricted list of ttys where root can log in
E 11
I 11
/etc/securettys	*	merged into ttys
E 11
/etc/ttys	*	terminal line configuration data
D 11
/etc/ttytype	*	terminal line to terminal type mapping data
E 11
I 11
/etc/ttytype	*	merged into ttys
E 11
/etc/termcap	\(dd	for any local entries that may have been added
/lib	\(dd	for any locally developed language processors
/usr/dict/*	\(dd	for local additions to words and papers
D 6
/usr/hosts/MAKEHOSTS	\(dg	for local changes
E 6
I 6
D 11
/usr/hosts/MAKEHOSTS	*	for local changes
E 11
E 6
/usr/include/*	\(dd	for local additions
D 6
/usr/lib/aliases	\(dg	mail forwarding data base
E 6
I 6
D 11
/usr/lib/aliases	\(dd	mail forwarding data base
E 6
/usr/lib/crontab	*	cron daemon data base
/usr/lib/font/*	\(dd	for locally developed font libraries
E 11
I 11
/usr/lib/aliases	*	mail forwarding data base (moves to \f(CW/etc/aliases\fP)
/usr/lib/crontab	*	cron daemon data base (moves to \f(CW/etc/crontab\fP)
I 14
/usr/lib/crontab.local	*	local cron daemon data base (moves to \f(CW/etc/crontab.local\fP)
E 14
E 11
D 21
/usr/lib/lib*.a	\(dg	for locally libraries
E 21
I 21
/usr/lib/lib*.a	\(dg	for local libraries
E 21
I 14
/usr/lib/mail.rc	\(dg	system-wide mail(1) initialization (moves to \f(CW/etc/mail.rc\fP)
E 14
D 11
/usr/lib/lint/*	\(dd	for locally developed lint libraries
/usr/lib/sendmail.cf	*	sendmail configuration
/usr/lib/tabset/*	\(dd	for locally developed tab setting files
/usr/lib/term/*	\(dd	for locally developed nroff drive tables
/usr/lib/tmac/*	\(dd	for locally developed troff/nroff macros
E 11
I 11
/usr/lib/sendmail.cf	*	sendmail configuration (moves to \f(CW/etc/sendmail.cf\fP)
/usr/lib/tmac/*	\(dd	for locally developed troff/nroff macros (moves to \f(CW/usr/share/tmac/*\fP)
E 11
/usr/lib/uucp/*	\(dg	for local uucp configuration files
D 6
/usr/man/manl	\(dg	for manual pages for locally developed programs
E 6
I 6
D 11
/usr/man/manl	*	for manual pages for locally developed programs
E 6
/usr/msgs	\(dg	for current msgs
/usr/spool/*	\(dg	for current mail, news, uucp files, etc.
E 11
I 11
/usr/man/manl	*	for manual pages for locally developed programs (moves to \f(CW/usr/local/man\fP)
/usr/spool/*	\(dg	for current mail, news, uucp files, etc. (moves to \f(CW/var/spool\fP)
E 11
/usr/src/local	\(dg	for source for locally developed programs
D 11
/sys/conf/HOST	\(dg	configuration file for your machine
/sys/conf/files.HOST	\(dg	list of special files in your kernel
/*/quotas	\(dg	file system quota files
E 11
I 11
/sys/conf/HOST	\(dg	configuration file for your machine (moves to \f(CW/sys/<arch>/conf\fP)
/sys/conf/files.HOST	\(dg	list of special files in your kernel (moves to \f(CW/sys/<arch>/conf\fP)
/*/quotas	*	filesystem quota files (moves to \f(CW/*/quotas.user\fP)
E 11
E 2
.TE
I 2
D 11
.sp
D 6
\(dg\|Files that can be used from 4.2BSD without change.
\(dd\|Files that need local modifications merged into 4.3BSD files.
*\|Files that require special work to merge and are discussed below.
E 6
I 6
\(dg\|Files that can be used from 4.2BSD or \*(Ps without change.
E 11
I 11
.DS
\(dg\|Files that can be used from \*(Ps without change.
E 11
D 24
\(dd\|Files that need local modifications merged into \*(4B files.
E 24
I 24
\(dd\|Files that need local changes merged into \*(4B files.
E 24
D 11
*\|Files that require special work to merge and are discussed
in section 3.3.
E 11
I 11
D 13
*\|Files that require special work to merge and are discussed in section 3.3.
E 13
I 13
*\|Files that require special work to merge and are discussed in section 3.4.
E 13
E 11
E 6
E 2
.DE
D 2
As 4.1BSD binary images will run unchanged under 4.2BSD
you should be certain to save any programs such as
compilers which you will need in
bootstrapping to 4.2BSD.*
.FS
* 4.2BSD can support a ``4.1BSD compatibility mode'' of system operation
whereby system calls from 4.1BSD are either emulated or safely ignored.
There are only two exceptions; programs which read directories or use
the old jobs library will not operate properly.  However, while 4.1BSD
binaries will execute under 4.2BSD
it is \fBSTRONGLY RECOMMENDED\fP that the programs be recompiled under
the new system.  Refer to the document ``Changes in 4.2BSD'' for elaboration
on this point.
.FE
E 2
I 2
D 6
.NH 3
E 6
I 6
D 32
.NH 2
E 6
Installing \*(4B
E 32
I 32
.Sh 2 "Installing \*(4B"
E 32
E 2
.PP
I 6
D 11
.if \n(Vx \{\
\fBNote\fP: The \*(4B release contains only Tahoe filesystems and executable
images.
In order to bring up \*(4B on a VAX, it is necessary to extract the sources
on a VAX, compile and install.
Most of the files listed above are found in /usr/src/sys/vaxdist
as well as in their standard locations on the distribution tape
so that the root and /usr images need not be extracted from the tape.
The following sections describe the procedure for installing \*(4B
on the Tahoe.
For a VAX system, the starting root and /usr filesystems can be created
by building and installing executables using alternate filesystems.
.\}
E 11
E 6
D 2
Once you have saved the appropriate files in a convenient format,
the next step is to dump your file systems with \fIdump\fP\|(8).
For the utmost of safety this should be done to magtape.  However,
if you enjoy gambling with your life (or you have a VERY friendly
user community) and you have sufficient disk space, you can try
converting your file systems in-place
by using a disk partition.  If you select the latter tact,
a version of the 4.1BSD dump program which runs under 4.2 is
provided in /etc/dump.4.1;  be sure to
read through this entire document before beginning the conversion.
Beware that file systems created under 4.2BSD will
use about 5-10% more disk space for file system related information
than under 4.1BSD.  Thus, before dumping each file system it is
a good idea to remove any files which may be easily regenerated.
Since most all programs will likely be recompiled under the new
system your best bet is to remove any object files.  File
systems with at least 10% free space on them should restore into
an equivalently sized 4.2BSD file system without problem.
E 2
I 2
The next step is to build a working \*(4B system.
This can be done by following the steps in section 2 of
D 11
this document for extracting the root and /usr file systems
from the distribution tape onto unused disk partitions.
D 6
If you have a running 4.2BSD system,
E 6
I 6
If you have a running 4.2BSD or \*(Ps system,
E 6
you can also do this by using
.IR dd (1)
to copy the \*(lqmini root\*(rq filesystem onto one disk partition,
D 6
then use it to load the \*(4B root filesystem as as chapter 2.
E 6
I 6
then use it to load the \*(4B root filesystem as in chapter 2.
E 6
The root filesystem dump on the tape could also be extracted directly,
although this will require an additional file system check after booting \*(4B
to convert the new root filesystem.
E 11
I 11
this document for extracting the root and
.Pn /usr
filesystems from the distribution tape onto unused disk partitions.
For the SPARC, the root filesystem dump on the tape could also be
extracted directly.
D 14
For the HP300 and DecStation, the raw disk image can be copied
E 14
I 14
For the HP300 and DECstation, the raw disk image can be copied
E 14
into an unused partition and this partition can then be dumped
to create an image that can be restored.
E 11
The exact procedure chosen will depend on the disk configuration
and the number of suitable disk partitions that may be used.
D 11
If there is insufficient space to load the new root and \fI/usr\fP
D 6
filesystems before reusing the existing 4.2BSD partitions,
D 4
it is strongly advised that you make full dumps of each filesystem
on magtape before beginning.
E 4
I 4
it is strongly advised that you make and verify full dumps of each
filesystem on magtape before beginning.
E 6
I 6
filesystems before reusing the existing partitions,
it is \fBSTRONGLY\fP advised that you make full dumps of each filesystem
on magtape before beginning.
E 6
E 4
It is also desirable to run file system checks
E 11
I 11
It is also desirable to run filesystem checks
E 11
D 6
of all filesystems to be converted to \*(4B before shutting down 4.2BSD.
If you are running an older system, you will have to
E 6
I 6
of all filesystems to be converted to \*(4B before shutting down.
D 11
If you are running a system older than 4.2BSD, you will have to
E 6
dump and restore your file systems; see section 2.1 for some hints.
In either case, this is an excellent time to review your disk configuration
E 11
I 11
In any case, this is an excellent time to review your disk configuration
E 11
for possible tuning of the layout.
D 6
Section 4.3 is required reading.
E 6
I 6
D 12
Section 4.2 and \fIconfig\fP(8) are required reading.
E 12
I 12
D 19
Section 4.2 and
E 19
I 19
Section 2.5 and
E 19
.Xr config (8)
are required reading.
E 12
E 6
E 2
D 16
.PP
E 16
I 16
.LP
E 16
I 15
The filesystem in \*(4B has been reorganized in an effort to
meet several goals:
.IP 1)
The root filesystem should be small.
.IP 2)
There should be a per-architecture centrally-shareable read-only
.Pn /usr
filesystem.
.IP 3)
Variable per-machine directories should be concentrated below
a single mount point named
.Pn /var .
.IP 4)
Site-wide machine independent shareable text files should be separated
from architecture specific binary files and should be concentrated below
a single mount point named
.Pn /usr/share .
.LP
These goals are realized with the following general layouts.
The reorganized root filesystem has the following directories:
.TS
lfC l.
D 27
etc	(config files)
bin	(user binaries needed when single-user)
sbin	(root binaries needed when single-user)
local	(locally added binaries used only by this machine)
tmp	(mount point for memory based file system)
dev	(local devices)
home	(mount point for AMD)
var	(mount point for per-machine variable directories)
usr	(mount point for multiuser binaries and files)
E 27
I 27
/etc	(config files)
/bin	(user binaries needed when single-user)
/sbin	(root binaries needed when single-user)
/local	(locally added binaries used only by this machine)
D 33
/tmp	(mount point for memory based file system)
E 33
I 33
/tmp	(mount point for memory based filesystem)
E 33
/dev	(local devices)
/home	(mount point for AMD)
/var	(mount point for per-machine variable directories)
/usr	(mount point for multiuser binaries and files)
E 27
.TE
.LP
The reorganized
.Pn /usr
filesystem has the following directories:
.TS
lfC l.
D 27
bin	(user binaries)
contrib	(software contributed to \*(4B)
games	(binaries for games, score files in \f(CW/var\fP)
include	(standard include files)
lib	(lib*.a from old \f(CW/usr/lib\fP)
libdata	(databases from old \f(CW/usr/lib\fP)
libexec	(executables from old \f(CW/usr/lib\fP)
local	(locally added binaries used site-wide)
old	(deprecated binaries)
sbin	(root binaries)
share	(mount point for site-wide shared text)
src	(mount point for sources)
E 27
I 27
/usr/bin	(user binaries)
/usr/contrib	(software contributed to \*(4B)
/usr/games	(binaries for games, score files in \f(CW/var\fP)
/usr/include	(standard include files)
/usr/lib	(lib*.a from old \f(CW/usr/lib\fP)
/usr/libdata	(databases from old \f(CW/usr/lib\fP)
/usr/libexec	(executables from old \f(CW/usr/lib\fP)
/usr/local	(locally added binaries used site-wide)
/usr/old	(deprecated binaries)
/usr/sbin	(root binaries)
/usr/share	(mount point for site-wide shared text)
/usr/src	(mount point for sources)
E 27
.TE
.LP
The reorganized
.Pn /usr/share
filesystem has the following directories:
.TS
lfC l.
D 16
lib	(tmac, learn, ms, me, etc)
E 16
D 27
calendar	(various useful calendar files)
dict	(dictionaries)
doc	(\*(4B manual sources)
games	(games text files)
groff_font	(groff font information)
man	(typeset manual pages)
misc	(dumping ground for random text files)
mk	(templates for \*(4B makefiles)
skel	(template user home directory files)
tmac	(various groff macro packages)
zoneinfo	(information on time zones)
E 27
I 27
/usr/share/calendar	(various useful calendar files)
/usr/share/dict	(dictionaries)
/usr/share/doc	(\*(4B manual sources)
/usr/share/games	(games text files)
/usr/share/groff_font	(groff font information)
/usr/share/man	(typeset manual pages)
/usr/share/misc	(dumping ground for random text files)
/usr/share/mk	(templates for \*(4B makefiles)
/usr/share/skel	(template user home directory files)
/usr/share/tmac	(various groff macro packages)
/usr/share/zoneinfo	(information on time zones)
E 27
.TE
.LP
The reorganized
.Pn /var
filesystem has the following directories:
.TS
lfC l.
D 27
account	(accounting files, formerly \f(CW/usr/adm\fP)
D 16
at	(at spooling area)
E 16
I 16
at	(\fIat\fP\|(1) spooling area)
E 16
backups	(backups of system files)
crash	(crash dumps)
db	(system-wide databases, e.g. tags)
games	(score files)
log	(log files)
mail	(users mail)
D 22
obj	(heirarchy to build \f(CW/usr/src\fP)
E 22
I 22
obj	(hierarchy to build \f(CW/usr/src\fP)
E 22
preserve	(preserve area for vi)
quotas	(directory to store quota files)
run	(directory to store *.pid files)
rwho	(rwho databases)
spool/ftp	(home directory for anonymous ftp)
spool/mqueue	(sendmail spooling directory)
spool/news	(news spooling area)
spool/output	(printer spooling area)
spool/uucp	(uucp spooling area)
D 24
tmp	(disk-based temp directory)
E 24
I 24
tmp	(disk-based temporary directory)
E 24
users	(root of per-machine user home directories)
E 27
I 27
/var/account	(accounting files, formerly \f(CW/usr/adm\fP)
/var/at	(\fIat\fP\|(1) spooling area)
/var/backups	(backups of system files)
/var/crash	(crash dumps)
/var/db	(system-wide databases, e.g. tags)
/var/games	(score files)
/var/log	(log files)
/var/mail	(users mail)
/var/obj	(hierarchy to build \f(CW/usr/src\fP)
/var/preserve	(preserve area for vi)
/var/quotas	(directory to store quota files)
/var/run	(directory to store *.pid files)
/var/rwho	(rwho databases)
/var/spool/ftp	(home directory for anonymous ftp)
/var/spool/mqueue	(sendmail spooling directory)
/var/spool/news	(news spooling area)
/var/spool/output	(printer spooling area)
/var/spool/uucp	(uucp spooling area)
/var/tmp	(disk-based temporary directory)
/var/users	(root of per-machine user home directories)
E 27
.TE
.PP
E 15
D 2
Once you have dumped the file systems you wish to convert to 4.2BSD,
install the system from the bootstrap tape as described in chapter 2,
then proceed to the next section.
E 2
I 2
D 11
To ease the transition to new kernels,
D 6
the 4.3BSD bootstrap routines now pass the identity of the boot device
E 6
I 6
the 4.3BSD and \*(4B
bootstrap routines pass the identity of the boot device
E 11
I 11
The \*(4B bootstrap routines pass the identity of the boot device
E 11
E 6
through to the kernel.
D 11
The kernel then uses that device as its root file system.
D 6
Thus, for example, if you boot from \fI/dev/hp1a\fP, the kernel will use hp1a
as its root file system.
If \fI/dev/hp1b\fP is configured as a swap partition, 
E 6
I 6
Thus, for example, if you boot from \fI/dev/\*(Dk1a\fP,
the kernel will use \*(Dk1a as its root file system.
If \fI/dev/\*(Dk1b\fP is configured as a swap partition, 
E 11
I 11
The kernel then uses that device as its root filesystem.
Thus, for example, if you boot from
.Pn /dev/\*(Dk1a ,
the kernel will use
.Pn \*(Dk1a
as its root filesystem. If
.Pn /dev/\*(Dk1b
is configured as a swap partition, 
E 11
E 6
it will be used as the initial swap area,
D 6
otherwise the normal primary swap area (\fI/dev/hp0b\fP) will be used.
The \*(4B bootstrap is backward compatible with 4.2BSD,
so you can replace your 4.2BSD bootstrap if you use it
E 6
I 6
D 11
otherwise the normal primary swap area (\fI/dev/\*(Dk0b\fP) will be used.
The \*(4B bootstrap is backward compatible with 4.2BSD and \*(Ps,
E 11
I 11
otherwise the normal primary swap area (\c
.Pn /dev/\*(Dk0b )
will be used.
The \*(4B bootstrap is backward compatible with \*(Ps,
E 11
so you can replace your old bootstrap if you use it
E 6
to boot your first \*(4B kernel.
I 27
However, the \*(Ps bootstrap cannot access \*(4B filesystems,
so if you plan to convert your filesystems to \*(4B,
you must install a new bootstrap \fIbefore\fP doing the conversion.
Note that SPARC users cannot build a \*(4B compatible version
of the bootstrap, so must \fInot\fP convert their root filesystem
to the new \*(4B format.
E 27
.PP
Once you have extracted the \*(4B system and booted from it,
you will have to build a kernel customized for your configuration.
If you have any local device drivers,
they will have to be incorporated into the new kernel.
D 6
See section 4.2.3 and ``Building 4.3BSD UNIX Systems with Config.''
E 6
I 6
D 11
See section 4.1.3 and ``Building 4.3BSD UNIX Systems with Config.''
E 11
I 11
See section 4.1.3 and ``Building 4.3BSD UNIX Systems with Config'' (SMM:2).
E 11
E 6
.PP
I 6
D 11
If converting from 4.2BSD, \*(Ps, or the CCI 1.21 release, your old
file systems must be converted.
.if \n(Vx \{\
E 6
D 5
The disk partitions in \*(4B are the same as those in 4.2BSD,
E 5
I 5
The standard disk partitions in \*(4B are the same as those
D 6
in 4.2BSD and 4.3BSD,
E 6
I 6
in 4.2BSD and \*(Ps,
E 6
E 5
except for those on the DEC UDA50; see section 4.3.2 for details.
D 6
If you have changed the disk partition sizes, be sure to
D 5
make the necessary table changes and boot your custom kernel
BEFORE trying to access any of your 4.2BSD file systems!
After doing this if necessary, the remaining 4.2BSD filesystems
E 5
I 5
make the necessary changes to your new disk labels
\fIbefore\fP trying to access any of your old file systems!
After doing this if necessary, the remaining filesystems
E 5
may be converted in place.
This is done by using the \*(4B version of
E 6
I 6
.\}
E 11
I 11
If converting from \*(Ps, your old filesystems should be converted.
E 11
If you've modified the partition
D 11
sizes from the original BSD or CCI ones, and are not already using the
E 11
I 11
sizes from the original \*(Ps ones, and are not already using the
E 11
D 22
\*(4B disk labels, you will have to modify the default disk partion
E 22
I 22
\*(4B disk labels, you will have to modify the default disk partition
E 22
tables in the kernel.  Make the necessary table changes and boot
your custom kernel \fBBEFORE\fP trying to access any of your old
D 11
file systems!  After doing this, if necessary, the remaining filesystems
E 11
I 11
filesystems!  After doing this, if necessary, the remaining filesystems
E 11
may be converted in place by running the \*(4B version of
E 6
D 12
.IR fsck (8)
E 12
I 12
.Xr fsck (8)
E 12
on each filesystem and allowing it to make the necessary corrections.
D 12
The new version of \fIfsck\fP is more
D 11
strict about the size of directories than the version supplied with 4.2BSD.
Thus the first time that it is run on a 4.2BSD file system,
E 11
I 11
strict about the size of directories than the version supplied with \*(Ps.
E 12
I 12
The new version of
.Xr fsck
is more strict about the size of directories than
the version supplied with \*(Ps.
E 12
Thus the first time that it is run on a \*(Ps filesystem,
E 11
it will produce messages of the form:
.DS
I 6
D 11
.if \n(Vx \{\
E 11
E 6
D 5
DIRECTORY ...: LENGTH xx NOT MULTIPLE OF 512 (ADJUSTED)
E 5
I 5
\fBDIRECTORY ...: LENGTH\fP xx \fBNOT MULTIPLE OF 512 (ADJUSTED)\fP
I 6
D 11
.\}
.if \n(Th \{\
\fBDIRECTORY ...: LENGTH\fP xx \fBNOT MULTIPLE OF 1024 (ADJUSTED)\fP
.\}
E 11
E 6
E 5
.DE
Length ``xx'' will be the size of the directory;
D 6
it will be expanded to the next multiple of 512 bytes.
E 6
I 6
D 11
it will be expanded to the next multiple of
.if \n(Vx \{\
512
.\}
.if \n(Th \{\
1024
.\}
bytes.
E 11
I 11
it will be expanded to the next multiple of 512 bytes.
E 11
E 6
D 5
Note that file systems are otherwise completely
compatible between 4.2BSD and \*(4B,
though running a \*(4B file system under 4.2BSD may cause more of the above
E 5
I 5
D 12
The new \fIfsck\fP will also set default \fIinterleave\fP and
E 12
I 12
The new
.Xr fsck
will also set default \fIinterleave\fP and
E 12
\fInpsect\fP (number of physical sectors per track) values on older
D 11
file systems, in which these fields were unused spares; this correction
E 11
I 11
filesystems, in which these fields were unused spares; this correction
E 11
will produce messages of the form:
.DS
D 14
\fBIMPOSSIBLE INTERLEAVE=0 IN SUPERBLOCK (SET TO DEFAULT)\fP*
E 14
I 14
\fBIMPOSSIBLE INTERLEAVE=0 IN SUPERBLOCK (SET TO DEFAULT)\fP\**
E 14
\fBIMPOSSIBLE NPSECT=0 IN SUPERBLOCK (SET TO DEFAULT)\fP
.DE
.FS
D 14
* The defaults are to set \fIinterleave\fP to 1 and
E 14
I 14
The defaults are to set \fIinterleave\fP to 1 and
E 14
D 11
\fInpsect\fP to \fInsect\fP;
I 6
.if \n(Vx \{\
E 6
this is correct on many drives.
Notable exceptions are the RM80 and RA81,
where npsect should be set to
one more than nsect.
This affects only performance (and in the case
of the RA81, at least, virtually unmeasurably).
I 6
.\}
.if \n(Th \{\
this is correct on all drives supported on the CCI.
.\}
E 11
I 11
\fInpsect\fP to \fInsect\fP.
This is correct on most drives;
D 24
it affects only performance (and in most cases, virtually unmeasurably).
E 24
I 24
it affects only performance (usually virtually unmeasurably).
E 24
E 11
E 6
.FE
D 11
File systems that have had their interleave and npsect values
E 11
I 11
Filesystems that have had their interleave and npsect values
E 11
D 12
set will be diagnosed by the old \fIfsck\fP as having a bad superblock;
the old \fIfsck\fP will run only if given an alternate superblock
E 12
I 12
set will be diagnosed by the old
.Xr fsck
as having a bad superblock; the old
.Xr fsck
will run only if given an alternate superblock
E 12
D 6
(\fIfsck \-b32\fP), in which case it will re-zero these fields.
E 6
I 6
D 11
.if \n(Vx \{\
E 11
(\fIfsck \-b32\fP),
D 11
.\}
.if \n(Th \{\
(\fIfsck \-b16\fP),
.\}
E 11
in which case it will re-zero these fields.
E 6
The \*(4B kernel will internally set these fields to their defaults
D 6
if fsck has not done so; again, the \fI\-b32\fP option may be
E 6
I 6
D 11
if fsck has not done so; again, the
.if \n(Vx \{\
\fI\-b32\fP
.\}
.if \n(Th \{\
\fI\-b16\fP
.\}
option may be
E 11
I 11
if fsck has not done so; again, the \fI\-b32\fP option may be
E 11
E 6
D 12
necessary for running the old \fIfsck\fP.
E 12
I 12
necessary for running the old
.Xr fsck .
E 12
.PP
D 11
In addition, \*(4B removes several limits on file system sizes
that were present in both 4.2BSD and 4.3BSD.
The limited file systems
E 11
I 11
In addition, \*(4B removes several limits on filesystem sizes
that were present in \*(Ps.
The limited filesystems
E 11
continue to work in \*(4B, but should be converted
as soon as it is convenient
D 11
by running \fIfsck\fP with the \fI\-c\fP option.
If no file systems have been so converted,
the sequence \fIfsck \-p \-c\fP will update all of them,
E 11
I 11
D 12
by running \fIfsck\fP with the \fI\-c 2\fP option.
E 12
I 12
by running
.Xr fsck
with the \fI\-c 2\fP option.
E 12
D 24
The sequence \fIfsck \-p \-c 2\fP will update all of them,
E 24
I 24
The sequence \fIfsck \-p \-c 2\fP will update them all,
E 24
E 11
fix the interleave and npsect fields,
D 11
and fix any incorrect directory lengths
all at once.
The new unlimited file system formats are treated as read-only
by older systems.
A second \fIfsck \-c\fP, however, will
reconvert the new format to the old if none of the static limits
of the old file system format have been exceeded.
The new file systems are otherwise
D 6
compatible between 4.2BSD, 4.3BSD, and \*(4B,
E 6
I 6
compatible between 4.2BSD, \*(Ps, and \*(4B,
E 6
though running a \*(4B file system under older systems
may cause more of the above
E 5
messages to be generated the next time it is \fIfsck\fP'ed on \*(4B.
E 11
I 11
fix any incorrect directory lengths,
expand maximum uid's and gid's to 32-bits,
place symbolic links less than 60 bytes into their inode,
and fill in directory type fields all at once.
The new filesystem formats are incompatible with older systems.
If you wish to continue using these filesystems with the older
systems you should make only the compatible changes using
\fIfsck \-c 1\fP.
E 11
E 2
D 32
.NH 2
I 6
D 11
.if \n(Th \{\
E 6
D 2
Step 2: merging
E 2
I 2
Merging your files from 4.2BSD into \*(4B
I 6
.\}
.if \n(Vx \{\
Merging your files from 4.2 or 4.3BSD into \*(4B
.\}
E 11
I 11
Merging your files from \*(Ps into \*(4B
E 32
I 32
.Sh 2 "Merging your files from \*(Ps into \*(4B"
E 32
E 11
E 6
E 2
.PP
D 2
When your system is booting reliably and you have the 4.2BSD
E 2
I 2
D 11
When your system is booting reliably and you have the \*(4B
E 2
root and /usr file systems fully installed you will be ready
E 11
I 11
When your system is booting reliably and you have the \*(4B root and
.Pn /usr
filesystems fully installed you will be ready
E 11
D 2
to proceed to the next
step in the conversion process:
E 2
I 2
to continue with the next step in the conversion process,
E 2
merging your old files into the new system.
.PP
D 2
Using the tar tape, or tapes, you created in step 1 extract
the appropriate files into a scratch directory, say /usr/convert:
E 2
I 2
D 12
If you saved the files on a \fItar\fP tape, extract them
D 11
into a scratch directory, say /usr/convert:
E 11
I 11
into a scratch directory, say
E 12
I 12
If you saved the files on a
.Xr tar
tape, extract them into a scratch directory, say
E 12
.Pn /usr/convert :
E 11
E 2
.DS
D 6
\fB#\fP mkdir /usr/convert
\fB#\fP cd /usr/convert
\fB#\fP tar x
E 6
I 6
\fB#\fP \fImkdir /usr/convert\fP
\fB#\fP \fIcd /usr/convert\fP
\fB#\fP \fItar xp\fP
E 6
.DE
.PP
D 2
Certain data files, such as those from the /etc directory,
may simply be copied into place.
.DS
\fB#\fP cp passwd group fstab ttys ttytype /etc
\fB#\fP cp crontab /usr/lib
.DE
Other files, however, must be merged into the distributed
versions by hand.  In particular, be careful with /etc/termcap.
E 2
I 2
The data files marked in the previous table with a dagger (\(dg)
may be used without change from the previous system.
Those data files marked with a double dagger (\(dd) have syntax 
changes or substantial enhancements.
You should start with the \*(4B version and carefully
integrate any local changes into the new file.
D 24
Usually these local modifications can be incorporated
E 24
I 24
Usually these local changes can be incorporated
E 24
without conflict into the new file;
some exceptions are noted below.
The files marked with an asterisk (*) require
particular attention and are discussed below.
E 2
.PP
D 2
The commands kept under the LOCAL entry in
/dev/MAKE should be placed in the new shell script /dev/MAKEDEV.local
so that saying ``MAKEDEV LOCAL'' will create the appropriate
local devices and device names.  If you have any homegrown device
drivers which use major device numbers reserved by the system you
E 2
I 2
D 11
If you have any homegrown device drivers in /dev/MAKEDEV.local
that use major device numbers reserved by the system you
E 2
will have to modify the commands used to create the devices or alter
D 6
the system device configuration tables in /sys/vax/conf.c.
E 6
I 6
the system device configuration tables in /sys/\*(mC/conf.c.
E 6
I 2
Otherwise /dev/MAKEDEV.local can be used without change
D 6
from 4.2BSD.
E 6
I 6
from 4.2 or \*(Ps.
E 11
I 11
D 27
The most immediately obvious change in \*(4B is the reorganization
E 27
I 27
As described in section 3.3,
the most immediately obvious change in \*(4B is the reorganization
E 27
of the system filesystems.
Users of certain recent vendor releases have seen this general organization,
although \*(4B takes the reorganization a bit further.
The directories most affected are
.Pn /etc ,
D 24
which now contains only system configuration files;
E 24
I 24
that now contains only system configuration files;
E 24
.Pn /var ,
a new filesystem containing per-system spool and log files; and
.Pn /usr/share,
D 24
which contains most of the text files shareable across architectures
E 24
I 24
that contains most of the text files shareable across architectures
E 24
such as documentation and macros.
System administration programs formerly in
.Pn /etc
are now found in
.Pn /sbin
and
.Pn /usr/sbin .
Various programs and data files formerly in
.Pn /usr/lib
are now found in
.Pn /usr/libexec
and
.Pn /usr/libdata ,
respectively.
Administrative files formerly in
.Pn /usr/adm
are in
.Pn /var/account
and, similarly, log files are now in
.Pn /var/log .
The directory
.Pn /usr/ucb
has been merged into
.Pn /usr/bin ,
and the sources for programs in
.Pn /usr/bin
are in
.Pn /usr/src/usr.bin .
Other source directories parallel the destination directories;
.Pn /usr/src/etc
has been greatly expanded, and
.Pn /usr/src/share
is new.
The source for the manual pages, in general, are with the source
code for the applications they document.
Manual pages not closely corresponding to an application program
are found in
.Pn /usr/src/share/man .
The locations of all man pages is listed in
.Pn /usr/src/share/man/man0/man[1-8] .
The manual page
.Xr hier (7)
has been updated and made more detailed;
it is included in the printed documentation.
You should review it to familiarize yourself with the new layout.
E 11
E 6
E 2
.PP
I 11
A new utility,
.Xr mtree (8),
is provided to build and check filesystem hierarchies
with the proper contents, owners and permissions.
Scripts are provided in
.Pn /etc/mtree
(and
.Pn /usr/src/etc/mtree )
for the root,
.Pn /usr
and
.Pn /var
filesystems.
Once a filesystem has been made for
.Pn /var ,
D 12
.I mtree
E 12
I 12
.Xr mtree
E 12
D 14
should be used to create a directory hierarchy there.
E 14
I 14
can be used to create a directory hierarchy there
or you can simply use tar to extract the prototype from
the second file of the distribution tape.
E 14
D 32
.NH 3
Changes in the
.Pn /etc
D 14
filesystem
E 14
I 14
directory
E 32
I 32
.Sh 3 "Changes in the \f(CW/etc\fP directory"
E 32
E 14
.PP
The
.Pn /etc
D 24
directory now contains nearly all of the host-specific configuration
E 24
I 24
directory now contains nearly all the host-specific configuration
E 24
files.
Note that some file formats have changed,
and those configuration files containing pathnames are nearly all affected
by the reorganization.
See the examples provided in
.Pn /etc
(installed from
.Pn /usr/src/etc )
as a guide.
The following table lists some of the local configuration files
whose locations and/or contents have changed.
D 15
.DS I .3i
E 15
.TS
l l l
lfC lfC l.
D 30
4.3BSD and Earlier	\*(4B	Comments
E 30
I 30
\*(Ps and Earlier	\*(4B	Comments
E 30
_	_	_
/etc/fstab	/etc/fstab	new format; see below
/etc/inetd.conf	/etc/inetd.conf	pathnames of executables changed
/etc/printcap	/etc/printcap	pathnames changed
/etc/syslog.conf	/etc/syslog.conf	pathnames of log files changed
/etc/ttys	/etc/ttys	pathnames of executables changed
/etc/passwd	/etc/master.passwd	new format; see below
/usr/lib/sendmail.cf	/etc/sendmail.cf	changed pathnames
/usr/lib/aliases	/etc/aliases	may contain changed pathnames
/etc/*.pid	/var/run/*.pid	
D 36
	
.T&
E 36
I 36
.TE
.ne 1i
.TS
E 36
l l l
lfC lfC l.
D 30
New in 4.3BSD-Tahoe	\*(4B	Comments
E 30
I 30
New in \*(Ps-Tahoe	\*(4B	Comments
E 30
_	_	_
/usr/games/dm.config	/etc/dm.conf	configuration for games (see \fIdm\fP\|(8))
/etc/zoneinfo/localtime	/etc/localtime	timezone configuration
/etc/zoneinfo	/usr/share/zoneinfo	timezone configuration
.TE
.ne 1.5i
.TS
l l l
lfC lfC l.
	New in \*(4B	Comments
_	_	_
D 14
	/etc/man.conf	lists directories searched by \fIman\fP\|(1)
E 14
I 14
	/etc/aliases.db	database version of the aliases file
	/etc/amd-home	location database of home directories
	/etc/amd-vol	location database of exported filesystems
D 16
	/etc/changelist	\f(CW/etc/security\fP files to back up and check
E 16
I 16
	/etc/changelist	\f(CW/etc/security\fP files to back up
E 16
	/etc/csh.cshrc	system-wide csh(1) initialization file
	/etc/csh.login	system-wide csh(1) login file
	/etc/csh.logout	system-wide csh(1) logout file
D 16
	/etc/disklabels	directory for saving disklabels from disklabel(8)
E 16
I 16
	/etc/disklabels	directory for saving disklabels
E 16
	/etc/exports	NFS list of export permissions
D 16
	/etc/ftpwelcome	welcome message displayed for ftp users; see ftpd(8)
E 16
I 16
	/etc/ftpwelcome	message displayed for ftp users; see ftpd(8)
E 16
E 14
	/etc/kerberosIV	Kerberos directory; see below
I 14
	/etc/man.conf	lists directories searched by \fIman\fP\|(1)
D 15
	/etc/master.passwd	master user data base; see pwd_mkdb(8).
E 15
	/etc/mtree	directory for local mtree files; see mtree(8)
	/etc/netgroup	NFS group list used in \f(CW/etc/exports\fP
	/etc/pwd.db	non-secure hashed user data base file
	/etc/spwd.db	secure hashed user data base file
	/etc/security	daily system security checker
E 14
.TE
D 15
.DE
E 15
.PP
E 11
I 2
D 12
System security changes require adding several new ``well-known'' groups 
to /etc/group.
E 12
I 12
System security changes require adding several new ``well-known'' groups to
.Pn /etc/group .
E 12
The groups that are needed by the system as distributed are:
D 15
.DS
E 15
.TS
D 11
l c.
name	number
E 11
I 11
l n l.
name	number	purpose
E 11
_
D 11
wheel	0
daemon	1
kmem	2
sys	3
tty	4
operator	5
D 6
staff	10
E 6
I 6
bin	10
E 11
I 11
wheel	0	users allowed superuser privilege
daemon	1	processes that need less than wheel privilege
kmem	2	read access to kernel memory
sys	3	access to kernel sources
tty	4	access to terminals
operator	5	read access to raw disks
bin	7	group for system binaries
news	8	group for news
wsrc	9	write access to sources
games	13	access to games
staff	20	system staff
guest	31	system guests
nobody	39	the least privileged group
utmp	45	access to utmp files
dialer	117	access to remote ports and dialers
E 11
E 6
.TE
I 36
.sp
E 36
D 15
.DE
E 15
D 12
Only users in the ``wheel'' group are permitted to \fIsu\fP to ``root''.
E 12
I 12
Only users in the ``wheel'' group are permitted to
.Xr su
to ``root''.
E 12
D 11
Most programs that manage directories in /usr/spool
E 11
I 11
Most programs that manage directories in
.Pn /var/spool
E 11
now run set-group-id to ``daemon'' so that users cannot
directly access the files in the spool directories.
D 11
The special files that access kernel memory, /dev/kmem
and /dev/mem, are made readable only by group ``kmem''.
E 11
I 11
The special files that access kernel memory,
.Pn /dev/kmem
and
.Pn /dev/mem ,
are made readable only by group ``kmem''.
E 11
Standard system programs that require this access are
made set-group-id to that group.
D 6
The group ``sys'' is intended to control access to system sources,
and other sources belong to group ``staff.''
E 6
I 6
The group ``sys'' is intended to control access to kernel sources,
D 11
and other sources belong to group ``bin.''
E 11
I 11
and other sources belong to group ``wsrc.''
E 11
E 6
D 14
Rather than make user's terminals writable by all users,
E 14
I 14
Rather than make user terminals writable by all users,
E 14
they are now placed in group ``tty'' and made only group writable.
D 14
Programs that should legitimately have access to write on user's terminals
E 14
I 14
Programs that should legitimately have access to write on user terminals
E 14
D 6
such as \fItalk\fP and \fIwrite\fP now run set-group-id to ``tty''.
E 6
I 6
D 12
such as \fItalkd\fP and \fIwrite\fP now run set-group-id to ``tty''.
E 12
I 12
such as
.Xr talkd
and
.Xr write
now run set-group-id to ``tty''.
E 12
E 6
The ``operator'' group controls access to disks.
By default, disks are readable by group ``operator'',
I 36
.sp
E 36
D 11
so that programs such as \fIdf\fP can access the file system
E 11
I 11
D 12
so that programs such as \fIdump\fP can access the filesystem
E 11
information without being set-user-id to ``root''.
E 12
I 12
so that programs such as
.Xr dump
can access the filesystem information without being set-user-id to ``root''.
E 12
I 6
The
D 12
.IR shutdown (8)
E 12
I 12
.Xr shutdown (8)
E 12
program is executable only by group operator
and is setuid to root so that members of group operator may shut down
the system without root access.
E 6
.PP
I 11
The ownership and modes of some directories have changed.
D 12
The \fIat\fP programs now run set-user-id ``root'' instead of ``daemon.''
E 12
I 12
The
.Xr at
programs now run set-user-id ``root'' instead of ``daemon.''
E 12
Also, the uucp directory no longer needs to be publicly writable,
D 12
as \fItip\fP reverts to privileged status to remove its lock files.
E 12
I 12
as
.Xr tip
reverts to privileged status to remove its lock files.
E 12
After copying your version of
.Pn /var/spool ,
you should do:
.DS
\fB#\fP \fIchown \-R root /var/spool/at\fP
\fB#\fP \fIchown \-R uucp.daemon /var/spool/uucp\fP
\fB#\fP \fIchmod \-R o\-w /var/spool/uucp\fP
.DE
.PP
The format of the cron table,
.Pn /etc/crontab ,
has been changed to specify the user-id that should be used to run a process.
The userid ``nobody'' is frequently useful for non-privileged programs.
D 24
Local modification are now put in a separate file,
E 24
I 24
Local changes are now put in a separate file,
E 24
.Pn /etc/crontab.local .
.PP
Some of the commands previously in
.Pn /etc/rc.local
have been moved to
.Pn /etc/rc ;
several new functions are now handled by
.Pn /etc/rc ,
.Pn /etc/netstart
and
.Pn /etc/rc.local .
You should look closely at the prototype version of these files
and read the manual pages for the commands contained in it
before trying to merge your local copy.
D 12
Note in particular that \fIifconfig\fP has had many changes,
E 12
I 12
Note in particular that
.Xr ifconfig
has had many changes,
E 12
and that host names are now fully specified as domain-style names
(e.g., vangogh.CS.Berkeley.EDU) for the benefit of the name server.
.PP
I 14
Some of the commands previously in
.Pn /etc/daily
have been moved to
.Pn /etc/security ,
and several new functions have been added to
.Pn /etc/security
to do nightly security checks on the system.
The script
.Pn /etc/daily
runs
.Pn /etc/security
each night, and mails the output to the super-user.
Some of the checks done by
.Pn /etc/security
are:
.DS
\(bu Syntax errors in the password and group files.
\(bu Duplicate user and group names and id's.
\(bu Dangerous search paths and umask values for the superuser.
\(bu Dangerous values in various initialization files.
\(bu Dangerous .rhosts files.
\(bu Dangerous directory and file ownership or permissions.
\(bu Globally exported filesystems.
\(bu Dangerous owners or permissions for special devices.
.DE
D 24
In addition, any modifications to setuid and setgid files, special
E 24
I 24
In addition, it reports any changes to setuid and setgid files, special
E 24
devices, or the files in
.Pn /etc/changelist
since the last run of
D 24
.Pn /etc/security
are noted.
E 24
I 24
.Pn /etc/security .
E 24
Backup copies of the files are saved in
.Pn /var/backups .
D 32
Finally, the system binaries are checksum'd and their permissions
E 32
I 32
Finally, the system binaries are checksummed and their permissions
E 32
validated against the
.Xr mtree (8)
specifications in
.Pn /etc/mtree .
.PP
E 14
The C-library and system binaries on the distribution tape
are compiled with new versions of
D 12
\fIgethostbyname\fP and \fIgethostbyaddr\fP which use
the name server,
.IR named (8).
E 12
I 12
.Xr gethostbyname
and
.Xr gethostbyaddr
D 24
which use the name server,
E 24
I 24
that use the name server,
E 24
.Xr named (8).
E 12
If you have only a small network and are not connected
to a large network, you can use the distributed library routines without
any problems; they use a linear scan of the host table
.Pn /etc/hosts
if the name server is not running.
If you are on the Internet or have a large local network,
it is recommend that you set up
and use the name server.
For instructions on how to set up the necessary configuration files,
refer to ``Name Server Operations Guide for BIND'' (SMM:10).
D 12
Several programs rely on the host name returned by \fIgethostname\fP
E 12
I 12
Several programs rely on the host name returned by
.Xr gethostname
E 12
to determine the local domain name.
.PP
D 12
If you are using the name server, your \fIsendmail\fP configuration
file will need some updates to accommodate it.
E 12
I 12
If you are using the name server, your
.Xr sendmail
configuration file will need some updates to accommodate it.
E 12
See the ``Sendmail Installation and Operation Guide'' (SMM:8) and
D 12
the sample \fIsendmail\fP configuration files in
E 12
I 12
the sample
.Xr sendmail
configuration files in
E 12
.Pn /usr/src/usr.sbin/sendmail/cf .
The aliases file,
.Pn /etc/aliases
has also been changed to add certain well-known addresses.
D 32
.NH 3
Shadow password files
E 32
I 32
.Sh 3 "Shadow password files"
E 32
.PP
The password file format adds change and expiration fields
and its location has changed to protect
the encrypted passwords stored there.
The actual password file is now stored in
.Pn /etc/master.passwd .
The hashed dbm password files do not contain encrypted passwords,
but contain the file offset to the entry with the password in
.Pn /etc/master.passwd
D 24
(which is readable only by root).
E 24
I 24
(that is readable only by root).
E 24
Thus, the
.Fn getpwnam
and
.Fn getpwuid
functions will no longer return an encrypted password string to non-root
callers.
An old-style passwd file is created in
.Pn /etc/passwd
by the
.Xr vipw (8)
and
.Xr pwd_mkdb (8)
programs.
See also
.Xr passwd (5).
.PP
E 11
D 12
Several new users have also been added to the group of ``well-known'' users 
in /etc/passwd.
E 12
I 12
Several new users have also been added to the group of ``well-known'' users in
.Pn /etc/passwd .
E 12
The current list is:
.DS
.TS
l c.
name	number
_
root	0
daemon	1
operator	2
I 11
bin	3
E 11
I 6
games	7
E 6
uucp	66
nobody	32767
.TE
.DE
The ``daemon'' user is used for daemon processes that
do not need root privileges.
The ``operator'' user-id is used as an account for dumpers
so that they can log in without having the root password.
By placing them in the ``operator'' group, 
they can get read access to the disks.
The ``uucp'' login has existed long before \*(4B,
and is noted here just to provide a common user-id.
The password entry ``nobody'' has been added to specify
D 6
the user with least privilege.
E 6
I 6
the user with least privilege.  The ``games'' user is a pseudo-user
that controls access to game programs.
E 6
.PP
D 11
After installing your updated password file,
you must run \fImkpasswd\fP\|(8) to create the \fIndbm\fP
password database.
Note that \fImkpasswd\fP is run whenever \fIvipw\fP\|(8) is run.
E 11
I 11
After installing your updated password file, you must run
.Xr pwd_mkdb (8)
to create the password database.
Note that
.Xr pwd_mkdb (8)
is run whenever
.Xr vipw (8)
is run.
D 32
.NH 3
The
.Pn /var
filesystem
E 32
I 32
.Sh 3 "The \f(CW/var\fP filesystem"
E 32
E 11
.PP
D 11
The format of the cron table, /usr/lib/crontab, has been changed
to specify the user-id that should be used to run a process.
The userid ``nobody'' is frequently useful for non-privileged programs.
E 11
I 11
The spooling directories saved on tape may be restored in their
eventual resting places without too much concern.  Be sure to
use the `\-p' option to
.Xr tar (1)
so that files are recreated with the same file modes.
The following commands provide a guide for copying spool and log files from
an existing system into a new
.Pn /var
filesystem.
At least the following directories should already exist on
.Pn /var :
.Pn output ,
.Pn log ,
.Pn backups
and
.Pn db .
.LP
.DS
.ft CW
SRC=/oldroot/usr
D 36

E 36
I 36
.sp
E 36
cd $SRC; tar cf - msgs preserve | (cd /var && tar xpf -)
.DE
.DS
I 13
.ft CW
E 13
# copy $SRC/spool to /var
cd $SRC/spool
tar cf - at mail rwho | (cd /var && tar xpf -)
tar cf - ftp mqueue news secretmail uucp uucppublic | \e
	(cd /var/spool && tar xpf -)
.DE
.DS
I 13
.ft CW
E 13
# everything else in spool is probably a printer area
mkdir .save
mv at ftp mail mqueue rwho secretmail uucp uucppublic .save
tar cf - * | (cd /var/spool/output && tar xpf -)
mv .save/* .
rmdir .save
.DE
.DS
I 13
.ft CW
E 13
cd /var/spool/mqueue
mv syslog.7 /var/log/maillog.7
mv syslog.6 /var/log/maillog.6
mv syslog.5 /var/log/maillog.5
mv syslog.4 /var/log/maillog.4
mv syslog.3 /var/log/maillog.3
mv syslog.2 /var/log/maillog.2
mv syslog.1 /var/log/maillog.1
mv syslog.0 /var/log/maillog.0
mv syslog /var/log/maillog
.DE
.DS
I 13
.ft CW
E 13
# move $SRC/adm to /var
cd $SRC/adm
tar cf - . | (cd /var/account && tar  xpf -)
cd /var/account
rm -f msgbuf
mv messages messages.[0-9] ../log
mv wtmp wtmp.[0-9] ../log
mv lastlog ../log
.DE
I 14
D 32
.NH 2
Bug fixes and changes between \*(Ps and \*(4B
E 32
I 32
.Sh 2 "Bug fixes and changes between \*(Ps and \*(4B"
E 32
.PP
The major new facilities available in the \*(4B release are
a new virtual memory system,
the addition of ISO/OSI networking support,
a new virtual filesystem interface supporting filesystem stacking,
a freely redistributable implementation of NFS,
a log-structured filesystem,
enhancement of the local filesystems to support
files and filesystems that are up to 2^63 bytes in size,
enhanced security and system management support,
and the conversion to and addition of the IEEE Std1003.1 (``POSIX'')
facilities and many of the IEEE Std1003.2 facilities.
In addition, many new utilities and additions to the C
library are present as well.
The kernel sources have been reorganized to collect all machine-dependent
files for each architecture under one directory,
and most of the machine-independent code is now free of code
conditional on specific machines.
The user structure and process structure have been reorganized
to eliminate the statically-mapped user structure and to make most
of the process resources shareable by multiple processes.
The system and include files have been converted to be compatible
with ANSI C, including function prototypes for most of the exported
functions.
There are numerous other changes throughout the system.
E 14
D 32
.NH 3
D 14
Block devices and the root filesystem
E 14
I 14
Changes to the kernel
E 32
I 32
.Sh 3 "Changes to the kernel"
E 32
E 14
E 11
.PP
I 14
This release includes several important structural kernel changes.
The kernel uses a new internal system call convention;
the use of global (``u-dot'') variables for parameters and error returns
has been eliminated,
and interrupted system calls no longer abort using non-local goto's (longjmp's).
A new sleep interface separates signal handling from scheduling priority,
returning characteristic errors to abort or restart the current system call.
This sleep call also passes a string describing the process state,
D 24
which is used by the ps(1) program.
E 24
I 24
that is used by the ps(1) program.
E 24
The old sleep interface can be used only for non-interruptible sleeps.
The sleep interface (\fItsleep\fP) can be used at any priority,
but is only interruptible if the PCATCH flag is set.
When interrupted, \fItsleep\fP returns EINTR or ERESTART.
.PP
Many data structures that were previously statically allocated
are now allocated dynamically.
These structures include mount entries, file entries,
user open file descriptors, the process entries, the vnode table,
the name cache, and the quota structures.
.PP
To protect against indiscriminate reading or writing of kernel
memory, all writing and most reading of kernel data structures
must be done using a new ``sysctl'' interface.
The information to be accessed is described through an extensible
``Management Information Base'' (MIB) style name,
described as a dotted set of components.
A new utility,
.Xr sysctl (8),
retrieves kernel state and allows processes with appropriate
privilege to set kernel state.
D 28
.PP
E 28
I 28
D 32
.NH 3
Security
E 32
I 32
.Sh 3 "Security"
.PP
E 32
E 28
The kernel runs with four different levels of security.
Any superuser process can raise the security level, but only 
D 27
.Fn init
E 27
I 27
.Fn init (8)
E 27
can lower it.
Security levels are defined as follows:
.IP \-1
Permanently insecure mode \- always run system in level 0 mode.
.IP "  0"
Insecure mode \- immutable and append-only flags may be turned off.
All devices may be read or written subject to their permissions.
.IP "  1"
Secure mode \- immutable and append-only flags may not be cleared;
disks for mounted filesystems,
.Pn /dev/mem ,
and
.Pn /dev/kmem
are read-only.
.IP "  2"
Highly secure mode \- same as secure mode, plus disks are always
read-only whether mounted or not.
This level precludes tampering with filesystems by unmounting them,
but also inhibits running
.Xr newfs (8)
while the system is multi-user.
I 28
See
.Xr chflags (1)
D 31
and the
.Op o
option to 
E 31
I 31
and the \-\fBo\fP option to 
E 31
.Xr ls (1)
for information on setting and displaying the immutable and append-only
flags.
E 28
.PP
Normally, the system runs in level 0 mode while single user
and in level 1 mode while multiuser.
If the level 2 mode is desired while running multiuser,
it can be set in the startup script
.Pn /etc/rc
using
.Xr sysctl (1).
If it is desired to run the system in level 0 mode while multiuser,
the administrator must build a kernel with the variable
.Li securelevel
in the kernel source file
.Pn /sys/kern/kern_sysctl.c
initialized to \-1.
D 32
.NH 4
Virtual memory changes
E 32
I 32
.Sh 4 "Virtual memory changes"
E 32
.PP
D 21
The new virtual memory implementation is derived from the MACH
E 21
I 21
The new virtual memory implementation is derived from the Mach
E 21
operating system developed at Carnegie-Mellon,
and was ported to the BSD kernel at the University of Utah.
D 21
The MACH virtual memory system call interface has been replaced with the
E 21
I 21
It is based on the 2.0 release of Mach
(with some bug fixes from the 2.5 and 3.0 releases)
and retains many of its essential features such as
the separation of the machine dependent and independent layers
(the ``pmap'' interface),
efficient memory utilization using copy-on-write
and other lazy-evaluation techniques,
and support for large, sparse address spaces.
It does not include the ``external pager'' interface instead using
a primitive internal pager interface.
The Mach virtual memory system call interface has been replaced with the
E 21
``mmap''-based interface described in the ``Berkeley Software
Architecture Manual'' (see UNIX Programmer's Manual,
Supplementary Documents, PSD:5).
The interface is similar to the interfaces shipped
by several commercial vendors such as Sun, USL, and Convex Computer Corp.
The integration of the new virtual memory is functionally complete,
but still has serious performance problems under heavy memory load.
The internal kernel interfaces have not yet been completed
and the memory pool and buffer cache have not been merged.
I 21
D 22
Some additional cavaets:
E 22
I 22
Some additional caveats:
E 22
.IP \(bu
Since the code is based on the 2.0 release of Mach,
bugs and misfeatures of the BSD version should not be considered
short-comings of the current Mach virtual memory system.
.IP \(bu
Because of the disjoint virtual memory (page) and IO (buffer) caches,
D 22
it is possible to see inconsistancies if using both the mmap and
E 22
I 22
it is possible to see inconsistencies if using both the mmap and
E 22
read/write interfaces on the same file simultaneously.
.IP \(bu
Swap space is allocated on-demand rather than up front and no
allocation checks are performed so it is possible to over-commit
memory and eventually deadlock.
.IP \(bu
The semantics of the
.Xr vfork (2)
system call are slightly different.
The synchronization between parent and child is preserved,
but the memory sharing aspect is not.
D 24
In practise this has been sufficient for backward compatibility,
E 24
I 24
D 27
In practise this has been enough for backward compatibility,
E 27
I 27
In practice this has been enough for backward compatibility,
E 27
E 24
but newer code should just use
.Xr fork (2).
E 21
D 32
.NH 4
Networking additions and changes
E 32
I 32
.Sh 4 "Networking additions and changes"
E 32
.PP
The ISO/OSI Networking consists of a kernel implementation of
transport class 4 (TP-4),
connectionless networking protocol (CLNP),
and 802.3-based link-level support (hardware-compatible with Ethernet\**).
.FS
Ethernet is a trademark of the Xerox Corporation.
.FE
We also include support for ISO Connection-Oriented Network Service,
X.25, TP-0.
The session and presentation layers are provided outside
the kernel using the ISO Development Environment by Marshall Rose,
D 24
which is available via anonymous FTP
E 24
I 24
that is available via anonymous FTP
E 24
(but is not included on the distribution tape).
Included in this development environment are file
transfer and management (FTAM), virtual terminals (VT),
a directory services implementation (X.500),
and miscellaneous other utilities.
.PP
Kernel support for the ISO OSI protocols is enabled with the ISO option
in the kernel configuration file.
The
.Xr iso (4)
manual page describes the protocols and addressing;
see also
.Xr clnp (4),
.Xr tp (4)
and
.Xr cltp (4).
The OSI equivalent to ARP is ESIS (End System to Intermediate System Routing
Protocol); running this protocol is mandatory, however one can manually add
translations for machines that do not participate by use of the
.Xr route (8)
command.
Additional information is provided in the manual page describing
.Xr esis (4).
.PP
The command
.Xr route (8)
D 24
has a new syntax and a number of new capabilities:
E 24
I 24
has a new syntax and several new capabilities:
E 24
it can install routes with a specified destination and mask,
and can change route characteristics such as hop count, packet size
and window size.
.PP
Several important enhancements have been added to the TCP/IP
protocols including TCP header prediction and
serial line IP (SLIP) with header compression.
The routing implementation has been completely rewritten
to use a hierarchical routing tree with a mask per route
to support the arbitrary levels of routing found in the ISO protocols.
The routing table also stores and caches route characteristics
to speed the adaptation of the throughput and congestion avoidance
algorithms.
.PP
The format of the
.I sockaddr
structure (the structure used to describe a generic network address with an
address family and family-specific data)
has changed from previous releases,
as have the address family-specific versions of this structure.
The
.I sa_family
family field has been split into a length,
D 25
.IR sa_len ,
E 25
I 25
.Pn sa_len ,
E 25
and a family,
D 25
.IR sa_family .
E 25
I 25
.Pn sa_family .
E 25
System calls that pass a
.I sockaddr
structure into the kernel (e.g.
.Fn sendto
and
.Fn connect )
have a separate parameter that specifies the 
.I sockaddr
length, and thus it is not necessary to fill in the
.I sa_len
field for those system calls.
System calls that pass a
.I sockaddr
structure back from the kernel (e.g. 
.Fn recvfrom
and
.Fn accept )
receive a completely filled-in
.I sockaddr
structure, thus the length field is valid.
Because this would not work for old binaries,
the new library uses a different system call number.
Thus, most networking programs compiled under \*(4B are incompatible
with older systems.
.PP
Although this change is mostly source and binary compatible
with old programs, there are three exceptions.
Programs with statically initialized
.I sockaddr
structures
(usually the Internet form, a
.I sockaddr_in )
are not compatible.
Generally, such programs should be changed to fill in the structure
at run time, as C allows no way to initialize a structure without
assuming the order and number of fields.
Also, programs with use structures to describe a network packet format
that contain embedded
.I sockaddr
D 24
structures also require modification; a definition of an
E 24
I 24
structures also require change; a definition of an
E 24
.I osockaddr
structure is provided for this purpose.
Finally, programs that use the
.Sm SIOCGIFCONF
ioctl to get a complete list of interface addresses
need to check the
.I sa_len
field when iterating through the array of addresses returned,
D 24
as not all of the structures returned have the same length
(in fact, this is nearly guaranteed by the presence of link-layer
E 24
I 24
as not all the structures returned have the same length
(this variance in length is nearly guaranteed by the presence of link-layer
E 24
address structures).
I 36
.sp
E 36
D 32
.NH 4
Additions and changes to filesystems
E 32
I 32
.Sh 4 "Additions and changes to filesystems"
E 32
.PP
D 30
The 4.4BSD distribution contains most of the interfaces
E 30
I 30
The \*(4B distribution contains most of the interfaces
E 30
specified in the IEEE Std1003.1 system interface standard.
Filesystem additions include IEEE Std1003.1 FIFOs,
byte-range file locking, and saved user and group identifiers.
.PP
A new virtual filesystem interface has been added to the
kernel to support multiple filesystems.
In comparison with other interfaces,
the Berkeley interface has been structured for more efficient support
of filesystems that maintain state (such as the local filesystem).
The interface has been extended with support for stackable
filesystems done at UCLA.
These extensions allow for filesystems to be layered on top of each
other and allow new vnode operations to be added without requiring
changes to existing filesystem implementations.
For example,
the umap filesystem (see
.Xr mount_umap (8))
is used to mount a sub-tree of an existing filesystem
that uses a different set of uids and gids than the local system.
Such a filesystem could be mounted from a remote site via NFS or it
could be a filesystem on removable media brought from some foreign
location that uses a different password file.
.PP
Other new filesystems that may be stacked include the loopback filesystem
.Xr mount_lofs (8),
the kernel filesystem
.Xr mount_kernfs (8),
and the portal filesystem
.Xr mount_portal (8).
.PP
E 14
D 11
Some of the commands previously in /etc/rc.local have been 
moved to /etc/rc;
D 6
several new functions are now handled by /etc/rc.local.
You should look closely at the prototype version of /etc/rc.local
E 6
I 6
several new functions are now handled by /etc/rc, /etc/netstart
and /etc/rc.local.
You should look closely at the prototype version of these files
E 6
and read the manual pages for the commands contained in it
before trying to merge your local copy.
Note in particular that \fIifconfig\fP has had many changes,
and that host names are now fully specified as domain-style names
(e.g, monet.Berkeley.EDU) for the benefit of the name server.
E 11
I 11
The buffer cache in the kernel is now organized as a file block cache
rather than a device block cache.
As a consequence, cached blocks from a file
and from the corresponding block device would no longer be kept consistent.
The block device thus has little remaining value.
Three changes have been made for these reasons:
D 14
(1) block devices may not be opened while they are mounted,
E 14
I 14
.IP 1)
block devices may not be opened while they are mounted,
E 14
and may not be mounted while open, so that the two versions of cached
file blocks cannot be created,
D 14
(2) filesystem checks of the root now use the raw device
E 14
I 14
.IP 2)
filesystem checks of the root now use the raw device
E 14
to access the root filesystem, and
D 14
(3) the root filesystem is initially mounted read-only
E 14
I 14
.IP 3)
the root filesystem is initially mounted read-only
E 14
D 24
so that nothing can be written back to disk during or after modification
of the raw filesystem by
E 24
I 24
so that nothing can be written back to disk during or after change to
the raw filesystem by
E 24
D 12
.I fsck .
E 12
I 12
.Xr fsck .
I 14
.LP
E 14
E 12
The root filesystem may be made writable while in single-user mode
D 14
with the command
.Li "mount -u /" .
E 14
I 14
with the command:
.DS
.ft CW
D 34
mount -u /
E 34
I 34
mount \-uw /
E 34
.DE
E 14
The mount command has an option to update the flags on a mounted filesystem,
including the ability to upgrade a filesystem from read-only to read-write
or downgrade it from read-write to read-only.
D 14
.NH 3
Kerberos
E 14
E 11
.PP
D 11
The C library and system binaries on the distribution tape
are compiled with new versions of
\fIgethostbyname\fP and \fIgethostbyaddr\fP which use
the name server,
.IR named (8).
If you have only a small network and are not connected
to a large network, you can use the distributed library routines without
any problems; they use a linear scan of the host table \fI/etc/hosts\fP
if the name server is not running.
If you are on the DARPA Internet or have a large local network,
it is recommend that you set up
and use the name server.
For instructions on how to set up the necessary configuration files,
refer to ``Name Server Operations Guide for BIND''.
Several programs rely on the host name returned by \fIgethostname\fP
to determine the local domain name.
E 11
I 11
D 14
The Kerberos authentication server from MIT (version 4)
is included in this release.
D 12
See \fIkerberos\fP\|(1) for a general, if MIT-specific,
introduction.
E 12
I 12
See
.Xr kerberos (1)
for a general, if MIT-specific, introduction.
E 12
If it is configured,
.Xr login (1),
.Xr passwd (1),
.Xr rlogin (1)
and
.Xr rsh (1)
will all begin to use it automatically.
The file
.Pn /etc/kerberosIV/README
describes the configuration.
Each system needs the file
.Pn /etc/kerberosIV/krb.conf
to set its realm and local servers,
and a private key stored in
.Pn /etc/kerberosIV/srvtab
(see
.Xr ext_srvtab (8)).
The Kerberos server should be set up on a single, physically secure,
server machine.
Users and hosts may be added to the server database manually with
.Xr kdb_edit (8),
or users on authorized hosts can add themselves and a Kerberos
password upon verification of their ``local'' (passwd-file) password
using the
.Xr register (1)
program.
E 11
.PP
D 11
If you want to compile your system to use the
host table lookup routines instead of the name server, you will
need to modify /usr/src/lib/libc/Makefile according to the instructions there
and then recompile all of the system and local programs (see section 6.6).
Next, you must run \fImkhosts\fP\|(8) to create the \fIndbm\fP
host table database from \fI/etc/hosts\fP.
E 11
I 11
Note that by default the password-changing program
.Xr passwd (1)
changes the Kerberos password, which must exist.
The
.Li \-l
option to
.Xr passwd (1)
changes the ``local'' password if one exists.
E 11
.PP
D 11
The format of /etc/ttys has changed, see \fIttys\fP\|(5)
for details.
It now includes the terminal type and security options that were previously
placed in /etc/ttytype and /etc/securettys.
E 11
I 11
Note that Version 5 of Kerberos will be released soon,
and that Version 4 should probably be replaced at that time.
.NH 3
Make and Makefiles
E 11
.PP
D 11
There is a new version of \fIsyslog\fP that uses a more generalized
facility/priority scheme.
This has changed the format of the syslog.conf file.
See \fIsyslogd\fP\|(8) for details.
\fISyslog\fP now logs kernel errors, 
allowing events such
as soft disk errors, filesystem-full messages, and other such error messages
to be logged without slowing down the system
while the messages print on the console.
It is also used by many of the system daemons
to monitor system problems more closely, for example
network routing changes.
E 11
I 11
This release uses a completely new version of the
D 12
.I make
E 12
I 12
.Xr make
E 12
program derived from the
D 12
.I pmake
E 12
I 12
.Xr pmake
E 12
program developed by the Sprite project at Berkeley.
It supports existing makefiles, although certain incorrect makefiles
may fail.
The makefiles for the \*(4B sources make extensive use of the new
facilities, especially conditionals and file inclusion, and are thus
completely incompatible with older versions of
D 12
.I make
E 12
I 12
.Xr make
E 12
(but nearly all of the makefiles are now trivial!).
The standard include files for
D 12
.I make
E 12
I 12
.Xr make
E 12
are in
.Pn /usr/share/mk .
There is a bsd.README file in
.Pn /usr/src/share/mk .
E 11
.PP
D 7
If you are using the name server, 
your \fIsendmail\fP configuration file will need some minor
updates to accommodate it.
E 7
I 7
D 11
If you are using the name server, your \fIsendmail\fP configuration
file will need some minor updates to accommodate it.
E 7
See the ``Sendmail Installation and Operation Guide'' and the sample
D 6
\fIsendmail\fP configuration files in /usr/src/usr.lib/sendmail/nscf.
E 6
I 6
\fIsendmail\fP configuration files in /usr/src/usr.lib/sendmail/cf.
I 7
The sendmail.cf's supplied with this release are alleged to be
``generic'', but have only really seen use at Berkeley.  In particular
there are two points to watch out for.  First, all host names in the
sendmail.cf itself must be fully qualified names.  Second, the
sendmail.cf's assume you have a /usr/lib/sendmail that was compiled
with the resolver library (i.e., not hosttables). This is necessary
to canonicalize unqualified names into fully-qualified names (e.g.,
foo -> foo.bar.com).  Using these .cf files with a host table can
probably be done, but it will be difficult.
E 7
E 6
Be sure to regenerate your sendmail frozen configuration file after
D 6
installation of your updated configuration file.
E 6
I 6
installation of your updated configuration file with the command
\fI/usr/lib/sendmail -bz\fP.
The aliases file,
/usr/lib/aliases has also been changed to add certain well-known addresses.
E 11
I 11
Another global change supported by the new
D 12
.I make
E 12
I 12
.Xr make
E 12
is designed to allow multiple architectures to share a copy of the sources.
If a subdirectory named
.Pn obj
is present in the current directory,
D 12
.I make
E 12
I 12
.Xr make
E 12
descends into that directory and creates all object and other files there.
We use this by building a directory hierarchy in
.Pn /var/obj
that parallels
.Pn /usr/src .
We then create the
.Pn obj
subdirectories in
.Pn /usr/src
as symbolic links to the corresponding directories in
.Pn /var/obj .
(Both of these steps are automated; the makefile in the
.Pn /usr/src
directory has an example of a target (``shadow'') which builds
the object filesystem, and ``make obj'' in a directory
including the standard \*(Bs rules in its Makefile makes the
.Pn obj
links in the current directory and recursively in the normal subdirectories.)
We have one
.Pn /var/obj
hierarchy on the local system, and another on each
system that shares the source filesystem.
.NH 3
Additions and changes to filesystems
E 11
E 6
.PP
E 2
D 11
The spooling directories saved on tape may be restored in their
eventual resting places without too much concern.  Be sure to
D 2
use the `p' option to tar so that files are recreated with the
E 2
I 2
use the `p' option to \fItar\fP so that files are recreated with the
E 2
same file modes:
.DS
D 6
\fB#\fP cd /usr
\fB#\fP tar xp msgs spool/mail spool/uucp spool/uucppublic spool/news
E 6
I 6
\fB#\fP \fIcd /usr\fP
\fB#\fP \fItar xp msgs spool/mail spool/uucp spool/uucppublic spool/news\fP
E 6
.DE
E 11
I 11
Network filesystem access is available in \*(4B.
An implementation of the Network File System (NFS) was contributed
by Rick Macklem of the University of Guelph.
E 14
I 14
In addition to the local ``fast filesystem'',
we have added an implementation of the network filesystem (NFS)
that fully interoperates with the NFS shipped by Sun and its licensees.
Because our NFS implementation was implemented
by Rick Macklem of the University of Guelph
using only the publicly available NFS specification,
it does not require a license from Sun to use in source or binary form.
By default it runs over UDP to be compatible with Sun's implementation.
However, it can be configured on a per-mount basis to run over TCP.
Using TCP allows it to be used quickly and efficiently through
gateways and over long-haul networks.
Using an extended protocol, it supports Leases to allow a limited
callback mechanism that greatly reduces the network traffic necessary
to maintain cache consistency between the server and its clients.
E 14
D 24
Its use will be fairly familiar to users of other implementations of NFS.
E 24
I 24
Its use will be familiar to users of other implementations of NFS.
E 24
See the manual pages
.Xr mount (8),
.Xr mountd (8),
.Xr fstab (5),
.Xr exports (5),
.Xr netgroup (5),
.Xr nfsd (8),
.Xr nfsiod (8),
and
.Xr nfssvc (8).
I 14
and the document ``The 4.4BSD NFS Implementation'' (SMM:6)
for further information.
E 14
The format of
.Pn /etc/fstab
has changed from previous \*(Bs releases
to a blank-separated format to allow colons in pathnames.
E 11
.PP
I 14
D 33
A new local file system, the log-structured file system (LFS),
E 33
I 33
A new local filesystem, the log-structured filesystem (LFS),
E 33
has been added to the system.
It provides near disk-speed output and fast crash recovery.
D 33
This work is based, in part, on the LFS file system created
E 33
I 33
This work is based, in part, on the LFS filesystem created
E 33
for the Sprite operating system at Berkeley.
D 24
While the kernel implementation is fairly complete,
E 24
I 24
While the kernel implementation is almost complete,
E 24
only some of the utilities to support the
filesystem have been written,
so we do not recommend it for production use.
See
.Xr newlfs (8),
.Xr mount_lfs (8)
and
.Xr lfs_cleanerd (8)
for more information.
For a in-depth description of the implementation and performance
D 33
characteristics of log-structured file systems in general,
E 33
I 33
characteristics of log-structured filesystems in general,
E 33
and this one in particular, see Dr. Margo Seltzer's doctoral thesis,
available from the University of California Computer Science Department.
.PP
We have also added a memory-based filesystem that runs in
pageable memory, allowing large temporary filesystems without
requiring dedicated physical memory.
.PP
The local ``fast filesystem'' has been enhanced to do 
D 24
clustering which allows large pieces of files to be
E 24
I 24
clustering that allows large pieces of files to be
E 24
allocated contiguously resulting in near doubling
of filesystem throughput.
The filesystem interface has been extended to allow
files and filesystems to grow to 2^63 bytes in size.
The quota system has been rewritten to support both
user and group quotas (simultaneously if desired).
Quota expiration is based on time rather than
the previous metric of number of logins over quota.
This change makes quotas more useful on fileservers
onto which users seldom login.
.PP
The system security has been greatly enhanced by the
addition of additional file flags that permit a file to be
marked as immutable or append only.
Once set, these flags can only be cleared by the super-user
D 16
when the system is running in insecure mode (normally single user).
E 16
I 16
when the system is running in insecure mode (normally, single-user).
I 23
In addition to the immutable and append-only flags,
D 24
the filsystem supports a new user-settable flag ``nodump''.
E 24
I 24
the filesystem supports a new user-settable flag ``nodump''.
E 24
(File flags are set using the
.Xr chflags (1)
utility.)
When set on a file,
.Xr dump (8)
will omit the file from incremental backups
but retain them on full backups.
See the ``-h'' flag to 
.Xr dump (8)
for details on how to change this default.
The ``nodump'' flag is usually set on core dumps,
system crash dumps, and object files generated by the compiler.
Note that the flag is not preserved when files are copied
so that installing an object file will cause it to be preserved.
.PP
The filesystem format used in \*(4B has several additions.
Directory entries have an additional field,
.Pn d_type ,
that identifies the type of the entry
(normally found in the
.Pn st_mode
field of the
.Pn stat
structure).
This field is particularly useful for identifying
directories without the need to use
.Xr stat (2).
.PP
Short (less than sixty byte) symbolic links are now stored
in the inode itself rather than in a separate data block.
This saves disk space and makes access of symbolic links faster.
Short symbolic links are not given a special type,
so a user-level application is unaware of their special treatment.
Unlike pre-\*(4B systems, symbolic links do
not have an owner, group, access mode, times, etc.
Instead, these attributes are taken from the directory that contains the link.
The only attributes returned from an
.Xr lstat (2)
that refer to the symbolic link itself are the file type (S_IFLNK),
size, blocks, and link count (always 1).
E 23
E 16
.PP
E 14
I 2
D 6
The ownership and modes of two of these directories
\fIat\fP now runs set-user-id ``daemon'' instead of root.
Also, the uucp directory no longer needs to be publicly writable,
as \fItip\fP reverts to priveleged status to remove its lock files.
After copying your version of /usr/spool, you should do:
.DS
\fB#\fP chown \-R daemon /usr/spool/at
D 3
\fB#\fP chown \-R root /usr/spool/uucp
E 3
I 3
\fB#\fP chown \-R uucp /usr/spool/uucp
E 3
\fB#\fP chgrp \-R daemon /usr/spool/uucp
\fB#\fP chmod \-R o\-w /usr/spool/uucp
.DE
.PP
E 2
Whatever else is left is likely to be site specific or require
careful scrutiny before placing in its eventual resting place.
Refer to the documentation and source code 
before arbitrarily overwriting a file.
E 6
I 6
D 11
The following two sections contain additional notes concerning
changes in \*(4B that affect the installation of local files;
be sure to read them as well.
E 11
I 11
An implementation of an auto-mounter daemon,
D 12
.I amd,
E 12
I 12
.Xr amd ,
E 12
was contributed by Jan-Simon Pendry of the
Imperial College of Science, Technology & Medicine.
See the document ``AMD \- The 4.4BSD Automounter'' (SMM:13)
for further information.
.PP
The directory
.Pn /dev/fd
contains special files
.Pn 0
through
.Pn 63
D 24
which, when opened, duplicate the corresponding file descriptor.
E 24
I 24
that, when opened, duplicate the corresponding file descriptor.
E 24
The names
D 28
.Pn /dev/stdin
E 28
I 28
.Pn /dev/stdin ,
E 28
.Pn /dev/stdout
I 28
and
E 28
.Pn /dev/stderr
refer to file descriptors 0, 1 and 2.
See
.Xr fd (4)
and
.Xr mount_fdesc (8)
for more information.
I 14
D 32
.NH 4
POSIX terminal driver changes
E 32
I 32
.Sh 4 "POSIX terminal driver changes"
E 32
E 14
.PP
D 14
The system now supports stackable filesystems;
this feature allows various filesystems to be stacked
on top of each other to provide additive sets of semantics.
For example,
the umap filesystem (see
.Xr mount_umap (8))
is used to mount a sub-tree of an existing filesystem
that uses a different set of uids and gids than the local system.
Such a filesystem could be mounted from a remote site via NFS or it
could be a filesystem on removable media brought from some foreign
location that uses a different password file.
.PP
Other new filesystems include the loopback filesystem
.Xr mount_lofs (8),
the kernel filesystem
.Xr mount_kernfs (8),
and the portal filesystem
.Xr mount_portal (8).
.NH 3
POSIX changes
.PP
E 14
The \*(4B system uses the IEEE P1003.1 (POSIX.1) terminal interface
rather than the previous \*(Bs terminal interface.
D 14
The new interface has nearly all of the functionality of the old interface,
extending the POSIX interface as necessary.
E 14
I 14
The terminal driver is similar to the System V terminal driver
with the addition of the necessary extensions to get the
functionality previously available in the \*(Ps terminal driver.
E 14
Both the old
D 12
.I ioctl
E 12
I 12
.Xr ioctl
E 12
calls and old options to
.Xr stty (1)
are emulated.
This emulation is expected to be unavailable in many vendors releases,
so conversion to the new interface is encouraged.
.PP
D 14
The POSIX.1 job control interface is implemented in \*(4B.
E 14
I 14
\*(4B also adds the IEEE Std1003.1 job control interface,
D 15
which is similar to the \(*Ps job control interface,
E 15
I 15
D 24
which is similar to the \*(Ps job control interface,
E 24
I 24
that is similar to the \*(Ps job control interface,
E 24
E 15
but adds a security model that was missing in the
D 15
\(*Ps job control implementation.
E 15
I 15
\*(Ps job control implementation.
E 15
E 14
A new system call,
.Fn setsid ,
D 24
is used to create a job-control session consisting of a single process
group with one member, the caller, which becomes a session leader.
E 24
I 24
creates a job-control session consisting of a single process
group with one member, the caller, that becomes a session leader.
E 24
Only a session leader may acquire a controlling terminal.
This is done explicitly via a
.Sm TIOCSCTTY
.Fn ioctl
call, not implicitly by an
.Fn open
call.
The call fails if the terminal is in use.
Programs that allocate controlling terminals (or pseudo-terminals)
D 24
require modification to work in this environment.
E 24
I 24
require change to work in this environment.
E 24
The versions of
D 12
.I xterm
E 12
I 12
.Xr xterm
E 12
provided in the X11R5 release includes the necessary changes.
New library routines are available for allocating and initializing
pseudo-terminals and other terminals as controlling terminal; see
.Pn /usr/src/lib/libutil/pty.c
and
.Pn /usr/src/lib/libutil/login_tty.c .
.PP
The POSIX job control model formalizes the previous conventions
used in setting up a process group.
Unfortunately, this requires that changes be made in a defined order
and with some synchronization that were not necessary in the past.
Older job control shells (csh, ksh) will generally not operate correctly
with the new system.
.PP
Most of the other kernel interfaces have been changed to correspond
D 24
with the POSIX.1 interface, although that work is not quite complete.
See the relevant manual pages, perhaps in conjunction with the IEEE POSIX
standard.
E 24
I 24
with the POSIX.1 interface, although that work is not complete.
See the relevant manual pages and the IEEE POSIX standard.
I 36
.sp
E 36
E 24
I 18
D 32
.NH 4
Native operating system compatibility
E 32
I 32
.Sh 4 "Native operating system compatibility"
E 32
.PP
Both the HP300 and SPARC ports feature the ability to run binaries
built for the native operating system (HP-UX or SunOS) by emulating
their system calls.
Building an HP300 kernel with the HPUXCOMPAT and COMPAT_OHPUX options
or a SPARC kernel with the COMPAT_SUNOS option will enable this feature
(on by default in the generic kernel provided in the root filesystem image).
Though this native operating system compatibility was provided by the
developers as needed for their purposes and is by no means complete,
D 24
it is sufficient to run a number of non-trivial applications including
those which require HP-UX or SunOS shared libraries.
E 24
I 24
it is complete enough to run several non-trivial applications including
those that require HP-UX or SunOS shared libraries.
E 24
I 21
For example, the vendor supplied X11 server and windowing environment
can be used on both the HP300 and SPARC.
E 21
.PP
It is important to remember that merely copying over a native binary
and executing it (or executing it directly across NFS) does not imply
that it will run.
All but the most trivial of applications are likely to require access
D 22
to auxilliary files that don't exist under \*(4B (e.g.
E 22
I 22
D 34
to auxiliary files that don't exist under \*(4B (e.g.
E 34
I 34
to auxiliary files that do not exist under \*(4B (e.g.
E 34
E 22
.Pn /etc/ld.so.cache )
or have a slightly different format (e.g.
.Pn /etc/passwd ).
However, by using system call tracing and
through creative use of symlinks,
many problems can be tracked down and corrected.
.PP
The DECstation port also has code for ULTRIX emulation
(kernel option ULTRIXCOMPAT, not compiled into the generic kernel)
but it was used primarily for initially bootstrapping the port and
has not been used since.
D 21
Hence, some work may be required to make it useful.
E 21
I 21
Hence, some work may be required to make it generally useful.
E 21
E 18
D 14
.PP
Many of the utilities have been changed to work as described in draft 14
of the POSIX.2 Shell and Utilities document.
Additional changes are likely in this area.
E 14
D 32
.NH 3
D 14
Networking additions and changes
E 14
I 14
Changes to the utilities
E 32
I 32
.Sh 3 "Changes to the utilities"
E 32
E 14
.PP
D 14
\*(4B provides some support for the ISO OSI protocols CLNP,
TP4, and ES-IS.
User level libraries and processes
implement the application protocols such as FTAM and X.500;
these are available in ISODE,
the ISO Development Environment by Marshall Rose,
which is available via anonymous FTP
(but is not included on the distribution tape).
E 14
I 14
We have been tracking the IEEE Std1003.2 shell and utility work
and have included prototypes of many of the proposed utilities
based on draft 12 of the POSIX.2 Shell and Utilities document.
Because most of the traditional utilities have been replaced
with implementations conformant to the POSIX standards,
you should realize that the utility software may not be as stable,
reliable or well documented as in traditional Berkeley releases.
In particular, almost the entire manual suite has been rewritten to
reflect the POSIX defined interfaces, and in some instances
it does not correctly reflect the current state of the software.
It is also worth noting that, in rewriting this software, we have generally
been rewarded with significant performance improvements.
Most of the libraries and header files have been converted
to be compliant with ANSI C.
The shipped compiler (gcc) is a superset of ANSI C,
but supports traditional C as a command-line option.
The system libraries and utilities all compile
with either ANSI or traditional C.
D 32
.NH 4
Make and Makefiles
E 32
I 32
.Sh 4 "Make and Makefiles"
E 32
E 14
.PP
D 14
Kernel support for the ISO OSI protocols is enabled with the ISO option
in the kernel configuration file.
The
.Xr iso (4)
manual page describes the protocols and addressing;
see also
.Xr clnp (4),
.Xr tp (4)
and
.Xr cltp (4).
The OSI equivalent to ARP is ESIS (End System to Intermediate System Routing
Protocol); running this protocol is mandatory, however one can manually add
translations for machines that do not participate by use of the
.Xr route (8)
command.
Additional information is provided in the manual page describing
.Xr esis (4).
E 14
I 14
This release uses a completely new version of the
.Xr make
program derived from the
.Xr pmake
program developed by the Sprite project at Berkeley.
It supports existing makefiles, although certain incorrect makefiles
may fail.
The makefiles for the \*(4B sources make extensive use of the new
facilities, especially conditionals and file inclusion, and are thus
completely incompatible with older versions of
.Xr make
D 24
(but nearly all of the makefiles are now trivial!).
E 24
I 24
(but nearly all the makefiles are now trivial!).
E 24
The standard include files for
.Xr make
are in
.Pn /usr/share/mk .
D 27
There is a bsd.README file in
E 27
I 27
There is a
.Pn bsd.README
file in
E 27
.Pn /usr/src/share/mk .
E 14
.PP
D 14
The command
.Xr route (8)
has a new syntax and a number of new capabilities:
it can install routes with a specified destination and mask,
and can change route characteristics such as hop count, packet size
and window size.
E 14
I 14
Another global change supported by the new
.Xr make
is designed to allow multiple architectures to share a copy of the sources.
If a subdirectory named
.Pn obj
is present in the current directory,
.Xr make
descends into that directory and creates all object and other files there.
We use this by building a directory hierarchy in
.Pn /var/obj
that parallels
.Pn /usr/src .
We then create the
.Pn obj
subdirectories in
.Pn /usr/src
as symbolic links to the corresponding directories in
.Pn /var/obj .
(This step is automated.
D 32
The command ``make obj'' builds both
the local symlink and the shadow directory, using
E 32
I 32
The command ``make obj'' in
.Pn /usr/src
builds both the local symlink and the shadow directory,
using
E 32
.Pn /usr/obj ,
D 24
which may be a symbolic link, as the root of the shadow tree.
E 24
I 24
that may be a symbolic link, as the root of the shadow tree.
E 24
The use of
.Pn /usr/obj
is for historic reasons only, and the system make configuration files in
.Pn /usr/share/mk
can trivially be modified to use
.Pn /var/obj
instead.)
We have one
.Pn /var/obj
hierarchy on the local system, and another on each
system that shares the source filesystem.
D 32
All the programs in
E 32
I 32
All the sources in
E 32
.Pn /usr/src
D 32
except
E 32
I 32
except for
E 32
.Pn /usr/src/contrib
I 32
and portions of
.Pn /usr/src/old
E 32
have been converted to use the new make and
.Pn obj
subdirectories;
this change allows compilation for multiple
architectures from the same source tree
D 24
(which may be mounted read-only).
E 24
I 24
(that may be mounted read-only).
E 24
D 32
.NH 4
Kerberos
E 32
I 32
.Sh 4 "Kerberos"
E 32
E 14
.PP
D 14
The format of the
.I sockaddr
structure (the structure used to describe a generic network address with an
address family and family-specific data)
has changed from previous releases,
as have the address family-specific versions of this structure.
The
.I sa_family
family field has been split into a length,
.IR sa_len ,
and a family,
.IR sa_family .
System calls that pass a
.I sockaddr
structure into the kernel (e.g.
.Fn sendto
E 14
I 14
The Kerberos authentication server from MIT (version 4)
is included in this release.
See
.Xr kerberos (1)
for a general, if MIT-specific, introduction.
If it is configured,
.Xr login (1),
.Xr passwd (1),
.Xr rlogin (1)
E 14
and
D 14
.Fn connect )
have a separate parameter that specifies the 
.I sockaddr
length, and thus it is not necessary to fill in the
.I sa_len
field for those system calls.
System calls that pass a
.I sockaddr
structure back from the kernel (e.g. 
.Fn recvfrom
and
.Fn accept )
receive a completely filled-in
.I sockaddr
structure, thus the length field is valid.
Because this would not work for old binaries,
the new library uses a different system call number.
Thus, most networking programs compiled under \*(4B are incompatible
with older systems.
E 14
I 14
.Xr rsh (1)
will all begin to use it automatically.
The file
.Pn /etc/kerberosIV/README
describes the configuration.
Each system needs the file
.Pn /etc/kerberosIV/krb.conf
to set its realm and local servers,
and a private key stored in
.Pn /etc/kerberosIV/srvtab
(see
.Xr ext_srvtab (8)).
The Kerberos server should be set up on a single, physically secure,
server machine.
Users and hosts may be added to the server database manually with
.Xr kdb_edit (8),
or users on authorized hosts can add themselves and a Kerberos
D 24
password upon verification of their ``local'' (passwd-file) password
E 24
I 24
password after verification of their ``local'' (passwd-file) password
E 24
using the
.Xr register (1)
program.
E 14
.PP
D 14
Although this change is mostly source and binary compatible
with old programs, there are three exceptions.
Programs with statically initialized
.I sockaddr
structures
(usually the Internet form, a
.I sockaddr_in )
are not compatible.
Generally, such programs should be changed to fill in the structure
at run time, as C allows no way to initialize a structure without
assuming the order and number of fields.
Also, programs with use structures to describe a network packet format
that contain embedded
.I sockaddr
structures also require modification; a definition of an
.I osockaddr
structure is provided for this purpose.
Finally, programs that use the
.Sm SIOCGIFCONF
ioctl to get a complete list of interface addresses
need to check the
.I sa_len
field when iterating through the array of addresses returned,
as not all of the structures returned have the same length
(in fact, this is nearly guaranteed by the presence of link-layer
address structures).
.NH 3
Additions and changes to utilities
E 14
I 14
Note that by default the password-changing program
.Xr passwd (1)
D 24
changes the Kerberos password, which must exist.
E 24
I 24
changes the Kerberos password, that must exist.
E 24
The
.Li \-l
option to
.Xr passwd (1)
changes the ``local'' password if one exists.
E 14
.PP
I 14
D 27
Note that Version 5 of Kerberos will be released soon,
and that Version 4 should probably be replaced at that time.
E 27
I 27
Note that Version 5 of Kerberos will be released soon;
Version 4 should probably be replaced at that time.
E 27
D 32
.NH 4
D 28
Additions and changes to other utilities
E 28
I 28
Additions and changes to the libraries
E 32
I 32
.Sh 4 "Timezone support"
E 32
E 28
.PP
I 32
The timezone conversion code in the C library uses data files installed in
.Pn /usr/share/zoneinfo
to convert from ``GMT'' to various timezones.  The data file for the default
timezone for the system should be copied to
.Pn /etc/localtime .
Other timezones can be selected by setting the TZ environment variable.
.PP
The data files initially installed in
.Pn /usr/share/zoneinfo
include corrections for leap seconds since the beginning of 1970.
Thus, they assume that the
kernel will increment the time at a constant rate during a leap second;
that is, time just keeps on ticking.  The conversion routines will then
name a leap second 23:59:60.  For purists, this effectively means that
the kernel maintains TAI (International Atomic Time) rather than UTC
(Coordinated Universal Time, aka GMT).
.PP
For systems that run current NTP (Network Time Protocol) implementations
or that wish to conform to the letter of the POSIX.1 law, it is possible
to rebuild the timezone data files so that leap seconds are not counted.
(NTP causes the time to jump over a leap second, and POSIX effectively
requires the clock to be reset by hand when a leap second occurs.
In this mode, the kernel effectively runs UTC rather than TAI.)
.PP
The data files without leap second information
are constructed from the source directory,
.Pn /usr/src/share/zoneinfo .
Change the variable REDO in Makefile
from ``right'' to ``posix'', and then do
.DS
make obj	(if necessary)
make
make install
.DE
.PP
You will then need to copy the correct default zone file to
.Pn /etc/localtime ,
as the old one would still have used leap seconds, and because the Makefile
installs a default
.Pn /etc/localtime
each time ``make install'' is done.
.PP
It is possible to install both sets of timezone data files.  This results
in subdirectories
.Pn /usr/share/zoneinfo/right
and
.Pn /usr/share/zoneinfo/posix .
Each contain a complete set of zone files.
See
.Pn /usr/src/share/zoneinfo/Makefile
for details.
.Sh 4 "Additions and changes to the libraries"
.PP
E 32
Notable additions to the libraries include functions to traverse a
filesystem hierarchy, database interfaces to btree and hashing functions,
D 28
a new, fast implementation of stdio and a radix sort function.
E 28
I 28
D 32
a new, fast implementation of stdio and a radix and merge sort functions.
E 32
I 32
a new, faster implementation of stdio and a radix and merge sort
functions.
E 32
.PP
The
.Xr fts (3)
D 30
functions will perform either physical or logical traversal of
a file hierarchy as well as handle essentially infinite depth
E 30
I 30
functions will do either physical or logical traversal of
D 32
a file hierarchy as well as handle almost infinite depth
E 30
file systems and file systems with directory loops.
E 32
I 32
a file hierarchy as well as handle essentially infinite depth
D 33
file systems and file systems with cycles.
E 33
I 33
filesystems and filesystems with cycles.
E 33
E 32
D 30
All of the utilities in \*(4B which traverse file hierarchies
E 30
I 30
All the utilities in \*(4B which traverse file hierarchies
E 30
have been converted to use
.Xr fts (3).
The conversion has always resulted in a significant performance
gain, often of four or five to one in system time.
.PP
The
.Xr dbopen (3)
functions are intended to be a family of database access methods.
Currently, they consist of
D 32
.Xr hash (3) ,
E 32
I 32
.Xr hash (3),
E 32
an extensible, dynamic hashing scheme,
D 32
.Xr btree (3) ,
E 32
I 32
.Xr btree (3),
E 32
a sorted, balanced tree structure (B+tree's), and
D 32
.Xr recno (3) ,
E 32
I 32
.Xr recno (3),
E 32
a flat-file interface for fixed or variable length records
referenced by logical record number.
Each of the access methods stores associated key/data pairs and
uses the same record oriented interface for access.
.PP
The
.Xr qsort (3)
function has been rewritten for additional performance.
In addition, three new types of sorting functions,
D 32
.Xr heapsort (3) ,
E 32
I 32
.Xr heapsort (3),
E 32
.Xr mergesort (3)
and
.Xr radixsort (3)
have been added to the system.
The
.Xr mergesort
function is optimized for data with pre-existing order,
in which case it usually significantly outperforms
.Xr qsort .
The
.Xr radixsort (3)
functions are variants of most-significant-byte radix sorting.
D 30
They take linear time relative to the number of bytes to be
E 30
I 30
They take time linear to the number of bytes to be
E 30
sorted, usually significantly outperforming
.Xr qsort
D 30
on data which can be sorted in this fashion.
E 30
I 30
on data that can be sorted in this fashion.
E 30
An implementation of the POSIX 1003.2 standard
D 32
.Xr sort 1 ,
E 32
I 32
.Xr sort (1),
E 32
based on
.Xr radixsort ,
is included in
.Pn /usr/src/contrib/sort .
.PP
D 30
Some additional comments concerning the \*(4B C library:
E 30
I 30
Some additional comments about the \*(4B C library:
E 30
.IP \(bu
The floating point support in the C library has been replaced
and is now accurate.
.IP \(bu
D 29
A POSIX 1003.2 compliant version of both basic and extended
regular expressions is provided as part of the C library.
.IP \(bu
The C functions specified by both ANSI C and POSIX 1003.1 and
E 29
I 29
The C functions specified by both ANSI C, POSIX 1003.1 and
E 29
1003.2 are now part of the C library.
D 29
This includes support for both file name matching and shell globbing.
E 29
I 29
This includes support for file name matching, shell globbing
and both basic and extended regular expressions.
E 29
.IP \(bu
D 29
The timezone routines have been replaced with a new timezone
package and are now accurate.
.IP \(bu
E 29
ANSI C multibyte and wide character support has been integrated.
The rune functionality from the Bell Labs' Plan 9 system is provided
as well.
.IP \(bu
The
.Xr termcap (3)
functions have been generalized and replaced with a general
purpose interface named
D 32
.Xr getcap (3) .
E 32
I 32
.Xr getcap (3).
E 32
.IP \(bu
The
.Xr stdio (3)
D 30
routines have been replaced, and, in many cases, are now much
faster.
E 30
I 30
D 32
routines have been replaced, and, are usually much faster.
E 32
I 32
routines have been replaced, and are usually much faster.
E 32
E 30
In addition, the
.Xr funopen (3)
interface permits applications to provide their own I/O stream
function support.
.PP
The
.Xr curses (3)
library has been largely rewritten.
Important additional features include support for scrolling and
D 32
.Xr termios (3) .
E 32
I 32
.Xr termios (3).
E 32
.PP
An application front-end editing library, named libedit, has been
added to the system.
.PP
D 30
A superset implementation of the  SunOS kernel memory interface library,
E 30
I 30
A superset implementation of the SunOS kernel memory interface library,
E 30
D 29
kvm, has been integrated into the system.
E 29
I 29
libkvm, has been integrated into the system.
.PP
D 32
Timezone support
The timezone conversion code in the C library uses data files installed in
.Pn /usr/share/zoneinfo
to convert from ``GMT'' to various timezones.  The data file for the default
timezone for the system should be copied to
.Pn /etc/localtime .
Other timezones can be selected by setting the TZ environment variable.
E 32
I 32
.Sh 4 "Additions and changes to other utilities"
E 32
.PP
D 32
The data files initially installed in
.Pn /usr/share/zoneinfo
include corrections for leap seconds since the beginning of 1970.
Thus, they assume that the
kernel will increment the time at a constant rate during a leap second;
that is, time just keeps on ticking.  The conversion routines will then
name a leap second 23:59:60.  For purists, this effectively means that
the kernel maintains TAI (International Atomic Time) rather than UTC
(Coordinated Universal Time, aka GMT).
.PP
For systems that run current NTP (Network Time Protocol) implementations
or that wish to conform to the letter of the POSIX.1 law, it is possible
to rebuild the timezone data files so that leap seconds are not counted.
(NTP causes the time to jump over a leap second, and POSIX effectively
requires the clock to be reset by hand when a leap second occurs.
In this mode, the kernel effectively runs UTC rather than TAI.)
.PP
The data files without leap second information
are constructed from the source directory,
.Pn /usr/src/share/zoneinfo .
Change the variable REDO in Makefile
from ``right'' to ``posix'', and then do
.DS
make obj	(if necessary)
make
make install
.DE
.PP
You will then need to copy the correct default zone file to
.Pn /etc/localtime ,
as the old one would still have used leap seconds, and because the Makefile
installs a default
.Pn /etc/localtime
each time ``make install'' is done.
.PP
It is possible to install both sets of timezone data files.  This results
in subdirectories
.Pn /usr/share/zoneinfo/right
and
.Pn /usr/share/zoneinfo/posix .
Each contain a complete set of zone files.
See
.Pn /usr/src/share/zoneinfo/Makefile
for details.
E 29
.NH 4
Additions and changes to other utilities
.PP
E 32
I 32
There are many new utilities, offering many new capabilities,
in \*(4B.
Skimming through the section 1 and section 8 manual pages is sure
to be useful.
E 32
E 28
The additions to the utility suite include greatly enhanced versions of
programs that display system status information, implementations of
various traditional tools described in the IEEE Std1003.2 standard,
I 32
new tools not previous available on Berkeley UNIX systems,
E 32
and many others.
I 28
D 30
Also, with only a very few exceptions, all of the utilities from
4.3BSD which included proprietary source code have been replaced
E 30
I 30
D 32
Also, with only a few exceptions, all the utilities from
\*(Ps that included proprietary source code have been replaced
E 32
I 32
Also, with only a very few exceptions, all the utilities from
\*(Ps that included proprietary source code have been replaced,
E 32
E 30
and their \*(4B counterparts are freely redistributable.
I 32
Normally, this replacement resulted in significant performance
improvements and the increase of the limits imposed on data by
the utility as well.
E 32
E 28
.PP
I 28
D 32
The  new version of
.Xr csh (1)
is significantly cleaner, freely redistributable, and 8-bit clean.
E 32
I 32
D 33
Examples of specific additions and changes are as follows:
E 33
I 33
A summary of specific additions and changes are as follows:
E 33
.TS
lfC l.
amd	An auto-mounter implementation.
ar	Replacement of the historic archive format with a new one.
awk	Replaced by gawk; see /usr/src/old/awk for the historic version.
bdes	Utility implementing DES modes of operation described in FIPS PUB 81.
calendar	Addition of an interface for system calendars.
cap_mkdb	Utility for building hashed versions of termcap style databases.
cc	Replacement of pcc with gcc suite.
chflags	A utility for setting the per-file user and system flags.
chfn	An editor based replacement for changing user information.
chpass	An editor based replacement for changing user information.
chsh	An editor based replacement for changing user information.
cksum	The POSIX 1003.2 checksum utility; compatible with sum.
column	A columnar text formatting utility.
cp	POSIX 1003.2 compatible, able to copy special files.
csh	Freely redistributable and 8-bit clean.
date	User specified formats added.
D 33
dd	New EBCDIC conversion tables, major performance improvments.
E 33
I 33
dd	New EBCDIC conversion tables, major performance improvements.
E 33
dev_mkdb	Hashed interface to devices.
dm	Dungeon master.
D 33
find	Several new options and primaries, major performance improvments.
E 33
I 33
find	Several new options and primaries, major performance improvements.
E 33
fstat	Utility displaying information on files open on the system.
ftpd	Connection logging added.
hexdump	A binary dump utility, superseding od.
id	The POSIX 1003.2 user identification utility.
inetd	Tcpmux added.
jot	A text formatting utility.
kdump	A system-call tracing facility.
ktrace	A system-call tracing facility.
kvm_mkdb	Hashed interface to the kernel name list.
lam	A text formatting utility.
lex	A new, freely redistributable, significantly faster version.
locate	A database of the system files, by name, constructed weekly.
logname	The POSIX 1003.2 user identification utility.
mail.local	New local mail delivery agent, replacing mail.
make	Replaced with a new, more powerful make, supporting include files.
man	Added support for man page location configuration.
mkdep	A new utility for generating make dependency lists.
mkfifo	The POSIX 1003.2 FIFO creation utility.
mtree	A new utility for mapping file hierarchies to a file.
nfsstat	An NFS statistics utility.
nvi	A freely redistributable replacement for the ex/vi editors.
pax	The POSIX 1003.2 replacement for cpio and tar.
printf	The POSIX 1003.2 replacement for echo.
roff	Replaced by groff; see /usr/src/old/roff for the historic versions.
rs	New utility for text formatting.
shar	An archive building utility.
D 33
sysctl	MIB-style interface to kernel state.
E 33
I 33
sysctl	MIB-style interface to system state.
E 33
tcopy	Fast tape-to-tape copying and verification.
touch	Time and file reference specifications.
tput	The POSIX 1003.2 terminal display utility.
tr	Addition of character classes.
uname	The POSIX 1003.2 system identification utility.
vis	A filter for converting and displaying non-printable characters.
xargs	The POSIX 1003.2 argument list constructor utility.
yacc	A new, freely redistributable, significantly faster version.
.TE
E 32
.PP
D 32
The POSIX 1003.2 replacement for
.Xr cpio (1)
and
.Xr tar (1) ,
named
.Xr pax (1)
is included with the system.
.PP
E 28
E 14
New versions of
E 32
I 32
The new versions of
E 32
.Xr lex (1)
(``flex'') and 
.Xr yacc (1)
D 32
(``zoo'')
have replaced their AT&T-derived predecessors.
These should be installed early on if attempting to cross-compile \*(4B
on another system.
E 32
I 32
(``zoo'') should be installed early on if attempting to
cross-compile \*(4B on another system.
E 32
Note that the new
.Xr lex
program is not completely backward compatible with historic versions of
.Xr lex ,
although it is believed that all documented features are supported.
.PP
D 32
A system-call tracing facility is provided in \*(4B
D 24
that records all of the system calls made by a process or group of processes
E 24
I 24
that records all the system calls made by a process or group of processes
E 24
and their outcomes.
See
.Xr ktrace (1)
and
.Xr kdump (1).
I 26
.PP
The system now has a database of file names,
constructed once a week from
.Xr cron .
To find a file by name only,
the command \fIlocate name\fP will look in the database for
files that match the name.
This command is much faster than the full filesystem traversal
done by find:
.DS
find / \-name name \-print
.DE
.PP
.Xr Find
D 30
itself has two new options which are important to be aware of
if you plan on using NFS.
E 30
I 30
itself has two new options that are important to be aware of
if you intend to use NFS.
E 32
I 32
The
.Xr find
utility has two new options that are important to be aware of if you
intend to use NFS.
E 32
E 30
The ``fstype'' and ``prune'' options can be used together to prevent
find from crossing NFS mount points.
See
.Pn /etc/daily
D 32
for an example use.
I 28
.PP
Finally, there are many new utilities offering many new capabilities,
in \*(4B.
Skimming through the section 1 and section 8 manual pages is sure
to be useful.
E 28
E 26
D 14
.PP
A new utility,
.Xr sysctl (8),
retrieves kernel state and allows processes with appropriate
privilege to set kernel state.
The state to be retrieved or
set is described using a ``Management Information Base'' (``MIB'') style
name, described as a dotted set of components.
.PP
The kernel runs with four different levels of security.
Any superuser process can raise the security level, but only 
.Fn init
can lower it.
Security levels are defined as follows:
.IP \-1
Permanently insecure mode \- always run system in level 0 mode.
D 13
.IP " 0"
E 13
I 13
.IP "  0"
E 13
Insecure mode \- immutable and append-only flags may be turned off.
All devices may be read or written subject to their permissions.
D 13
.IP " 1"
E 13
I 13
.IP "  1"
E 13
Secure mode \- immutable and append-only flags may not be cleared;
disks for mounted filesystems,
.Pn /dev/mem ,
and
.Pn /dev/kmem
are read-only.
D 13
.IP " 2"
E 13
I 13
.IP "  2"
E 13
Highly secure mode \- same as secure mode, plus disks are always
read-only whether mounted or not.
This level precludes tampering with filesystems by unmounting them,
but also inhibits running
.Xr newfs (8)
while the system is multi-user.
.PP
Normally, the system runs in level 0 mode while single user
and in level 1 mode while multiuser.
If the level 2 mode is desired while running multiuser,
it can be set in the startup script
.Pn /etc/rc
using
.Xr sysctl (1).
If it is desired to run the system in level 0 mode while multiuser,
the administrator must build a kernel with the variable
.Li securelevel
in the kernel source file
.Pn /sys/kern/kern_sysctl.c
initialized to \-1.
E 14
E 11
E 6
.NH 2
D 2
Step 3: converting file systems
E 2
I 2
D 11
Hints on converting from 4.2BSD to \*(4B
E 11
I 11
Hints on converting from \*(Ps to \*(4B
E 32
I 32
for an example of their use.
.Sh 2 "Hints on converting from \*(Ps to \*(4B"
E 32
E 11
E 2
.PP
D 2
The dump format used in 4.0 and 4.1BSD is upward
compatible with that
used in 4.2BSD.  That is, the 4.2BSD
.I restore
program understands
how to read old dump tapes, although 4.2BSD dump tapes may not
be properly restored under 4.0BSD or 4.1BSD.  To convert a file system
dumped to magtape, simply create the appropriate file system
and restore the data.  Note that the 4.2BSD
.I restore
program does
its work on a mounted file system using normal system operations
(unlike the older
.I restor
which accessed the raw file
system device and deposited inodes in the appropriate locations
on disk).  This means that file system dumps may be restored even
if the characteristics of the file system changed.  To restore
a dump tape for, say, the /a file system something like the following
would be used:
.DS
\fB#\fP mkdir /a
\fB#\fP newfs hp1g eagle
\fB#\fP mount /dev/hp1g /a
\fB#\fP cd /a
\fB#\fP restore r
.DE
If tar images were written instead of doing a dump, you should
be sure to use the `p' option when reading the files back.
No matter how you restore a file system, be sure and check its
integrity with fsck when the job is complete.
.NH 2
Bootstrapping language processors
E 2
I 2
D 29
This section summarizes the most significant changes between
D 6
4.2BSD and \*(4B, particularly those that are likely to 
E 6
I 6
D 11
4.2BSD and 4.3BSD, particularly those that are likely to 
E 11
I 11
\*(Ps and \*(4B particularly those that are likely to 
E 29
I 29
This section summarizes changes between
\*(Ps and \*(4B that are likely to 
E 29
E 11
E 6
cause difficulty in doing the conversion.
It does not include changes in the network;
D 11
see chapter 5 for information on setting up the network.
E 11
I 11
see section 5 for information on setting up the network.
E 11
E 2
.PP
D 2
To convert a compiler from 4.1BSD
to 4.2BSD you should simply have to recompile and relink the
various parts.  If the processor is written in itself, for instance
a PASCAL compiler written in PASCAL, the important step in
converting is to save a working copy of the 4.1BSD binary before
converting to 4.2BSD.  Then, once the system has been changed over,
the 4.1BSD binary should be used in the rebuilding process. 
In order to do this, you should enable the 4.1 compatibility
option when you configure the kernel (below).
E 2
I 2
D 11
The mailbox locking protocol has changed;
it now uses the advisory locking facility to avoid concurrent
update of users' mail boxes.
If you have your own mail interface, be sure to update its locking protocol.
E 11
I 11
D 18
The stat st_size field is now 64-bits instead of 32.
Doing something like:
E 18
I 18
Since the stat st_size field is now 64-bits instead of 32,
doing something like:
E 18
.DS
I 21
.ft CW
E 21
foo(st.st_size);
.DE
D 18
and then (improperly) defining foo with an "int" or "long" param:
E 18
I 18
and then (improperly) defining foo with an ``int'' or ``long'' parameter:
E 18
.DS
I 21
.ft CW
E 21
foo(size)
	int size;
{
	...
}
.DE
will fail miserably (well, it might work on a little endian machine).
D 21
This problem showed up in emacs as well as several other programs.
E 21
I 21
This problem showed up in
.Xr emacs (1)
as well as several other programs.
E 21
A related problem is improperly casting (or failing to cast)
D 18
the second argument to lseek (or [f]truncate) ala:
E 18
I 18
D 21
the second argument to lseek or [f]truncate ala:
E 21
I 21
the second argument to
.Xr lseek (2),
.Xr truncate (2),
or
.Xr ftruncate (2)
ala:
E 21
E 18
.DS
I 21
.ft CW
E 21
lseek(fd, (long)off, 0);
.DE
or
.DS
I 21
.ft CW
E 21
lseek(fd, 0, 0);
.DE
The best solution is to include
D 21
.Pn <sys/types.h>
E 21
I 21
.Pn <unistd.h>
E 21
which has prototypes that catch these types of errors.
E 11
E 2
.PP
I 11
D 18
Determining the namelen param for a connect call on a unix domain socket
should use the SUN_LEN macro.
E 18
I 18
D 21
Determining the ``namelen'' parameter for a connect call on a
unix domain socket should use the SUN_LEN macro.
E 21
I 21
Determining the ``namelen'' parameter for a
.Xr connect (2)
call on a unix domain socket should use the ``SUN_LEN'' macro from
.Pn <sys/un.h> .
E 21
E 18
One old way that was used:
.DS
D 21
addrlen = strlen(unaddr.sun_path) + sizeof(unaddr.sun_family);
E 21
I 21
D 26
addrlen  =  strlen(unaddr.sun_path)  +  sizeof(unaddr.sun_family);
E 26
I 26
.ft CW
addrlen = strlen(unaddr.sun_path) + sizeof(unaddr.sun_family);
E 26
E 21
.DE
D 18
no longer works as there is an additional field "sun_len".
E 18
I 18
D 26
no longer works as there is an additional field ``sun_len''.
E 26
I 26
no longer works as there is an additional
.Pn sun_len
field.
E 26
E 18
D 29
.PP
The timezone conversion code uses data files installed in
.Pn /usr/share/zoneinfo
D 18
to convert from "GMT" to various timezones.  The data file for the default
E 18
I 18
to convert from ``GMT'' to various timezones.  The data file for the default
E 18
timezone for the system should be copied to
.Pn /etc/localtime .
Other timezones can be selected by setting the TZ environment variable.
.PP
The data files initially installed in
.Pn /usr/share/zoneinfo
include corrections for leap seconds since the beginning of 1970.
Thus, they assume that the
kernel will increment the time at a constant rate during a leap second;
that is, time just keeps on ticking.  The conversion routines will then
name a leap second 23:59:60.  For purists, this effectively means that
the kernel maintains TAI (International Atomic Time) rather than UTC
(Coordinated Universal Time, aka GMT).
.PP
For systems that run current NTP (Network Time Protocol) implementations
or that wish to conform to the letter of the POSIX.1 law, it is possible
to rebuild the timezone data files so that leap seconds are not counted.
(NTP causes the time to jump over a leap second, and POSIX effectively
requires the clock to be reset by hand when a leap second occurs.
In this mode, the kernel effectively runs UTC rather than TAI.)
.PP
The data files without leap second information
are constructed from the source directory,
.Pn /usr/src/share/zoneinfo .
Change the variable REDO in Makefile
D 18
from "right" to "posix", and then do
E 18
I 18
from ``right'' to ``posix'', and then do
E 18
.DS
make obj	(if necessary)
make
make install
.DE
.PP
You will then need to copy the correct default zone file to
.Pn /etc/localtime ,
as the old one would still have used leap seconds, and because the Makefile
installs a default
.Pn /etc/localtime
each time ``make install'' is done.
.PP
It is possible to install both sets of timezone data files.  This results
in subdirectories
.Pn /usr/share/zoneinfo/right
and
.Pn /usr/share/zoneinfo/posix .
Each contain a complete set of zone files.
See
.Pn /usr/src/share/zoneinfo/Makefile
for details.
E 29
.PP
E 11
D 2
If no working 4.1BSD binary exists, or the language processor
uses some nonstandard system call, you will likely have to compile
the language processor into an intermediate form, such as assembly
language, on a 4.1BSD system, then bring the intermediate form
to 4.2BSD for assembly and loading.
E 2
I 2
The kernel's limit on the number of open files has been
D 11
increased from 20 to 64.  It is now possible to change this limit almost
arbitrarily (there used to be a hard limit of 30).  The standard I/O library
E 11
I 11
increased from 20 to 64.
It is now possible to change this limit almost arbitrarily.
The standard I/O library
E 11
autoconfigures to the kernel limit.
D 12
Note that file (``_iob'') entries may be allocated
by \fImalloc\fP from \fIfopen\fP;
E 12
I 12
Note that file (``_iob'') entries may be allocated by
.Xr malloc
from
.Xr fopen ;
E 12
this allocation has been known to cause problems with programs
that use their own memory allocators.
D 27
This does not occur until after 20 files have been opened
E 27
I 27
Memory allocation does not occur until after 20 files have been opened
E 27
by the standard I/O library.
.PP
D 12
\fISelect\fP can be used with more than 32 descriptors
E 12
I 12
.Xr Select
can be used with more than 32 descriptors
E 12
by using arrays of \fBint\fPs for the bit fields rather than single \fBint\fPs.
D 12
Programs that used \fIgetdtablesize\fP as their first argument to \fIselect\fP
E 12
I 12
Programs that used
.Xr getdtablesize
as their first argument to
.Xr select
E 12
will no longer work correctly.
Usually the program can be modified to correctly specify the number
of bits in an \fBint\fP.
Alternatively the program can be modified to use an array of \fBint\fPs.
D 11
There are a set of macros available in \fI<sys/types.h>\fP to simplify this.
E 11
I 11
There are a set of macros available in
.Pn <sys/types.h>
to simplify this.
E 11
See
D 12
.IR select (2).
E 12
I 12
.Xr select (2).
E 12
.PP
Old core files will not be intelligible by the current debuggers
because of numerous changes to the user structure
and because the kernel stack has been enlarged.
D 12
The \fIa.out\fP header that was in the user structure is no longer present.
E 12
I 12
The
.Xr a.out
header that was in the user structure is no longer present.
E 12
Locally-written debuggers that try to check the magic number
D 24
will need modification.
E 24
I 24
will need to be changed.
E 24
D 26
.PP
D 11
\fIFind\fP now has a database of file names,
E 11
I 11
The system now has a database of file names,
E 11
D 12
constructed once a week from \fIcron\fP.
E 12
I 12
constructed once a week from
.Xr cron .
E 12
To find a file by name only,
D 11
the command \fIfind name\fP will look in the database for
files that match the name.  This is much faster than
\fIfind / \-name name \-print\fP.
E 11
I 11
the command \fIlocate name\fP will look in the database for
files that match the name.
This command is much faster than the full filesystem traversal
done by find:
.DS
find / \-name name \-print
.DE
E 26
E 11
.PP
Files may not be deleted from directories having the ``sticky'' (ISVTX) bit
set in their modes
except by the owner of the file or of the directory, or by the superuser.
This is primarily to protect users' files in publicly-writable directories
D 11
such as \fI/tmp\fP and \fI/usr/tmp\fP.
E 11
I 11
such as
.Pn /tmp
and
.Pn /var/tmp .
E 11
All publicly-writable directories should have their ``sticky'' bits set
with ``chmod +t.''
.PP
D 11
The include file \fI<time.h>\fP has returned to \fI/usr/include\fP,
and again contains the definitions for the C library time routines of
\fIctime\fP\|(3).
.PP
The \fIcompact\fP and \fIuncompact\fP programs have been supplanted
by the faster \fIcompress\fP.
If your user population has \fIcompact\fPed files, you will want
D 6
to install \fIuncompact\fP found in /usr/src/old/compact.
E 6
I 6
to install \fIuncompact\fP from /usr/src/old/compact.
E 6
.PP
The configuration of the virtual memory limits has been simplified.
A MAXDSIZ option, specified in bytes in the machine configuration file,
may be used to raise the maximum process region size from
the default of 17Mb to 32Mb or 64Mb.
The initial per-process limit is still 6Mb,
but can be raised up to MAXDSIZ with the \fIcsh limit\fP command.
.PP
Some \*(4B binaries will not run with a 4.2BSD kernel because
they take advantage of new functionality in \*(4B.
One noticeable example of this problem is \fIcsh\fP.
I 6
.if \n(Th \{\
Also, most terminal \fIioctl\fP operations are incompatible
between \*(4B and the vendor-supplied versions of 4.2BSD.
.\}
E 6
.PP
If you want to use \fIps\fP after booting a new kernel,
and before going multiuser, you must initialize its name list
database by running \fIps \-U\fP.
I 6
.NH 2
Hints on converting from 4.3BSD to \*(4B
.PP
The largest visible change between 4.3BSD to \*(4B
(other than the addition of support for the Tahoe processor)
is the addition of support for disk labels.
This facility allows each disk or disk pack to contain all geometry
information about the disk and the partition layout for the disk.
Disk labels are supported on all disk types on the Tahoe machines,
and on hp and ra/rd disks on the VAX.
See section 2.1.6 as well as
.IR disklabel (8)
and
.IR disklabel (5).
Installation of this facility requires use of the new kernel and device
drivers, bootstraps and other standalone programs,
/etc/disktab,
.if \n(Vx \{\
.IR bad144 (8V),
.\}
.IR newfs (8),
and probably other programs.
.PP
The bootstrap programs have been fixed to work on MicroVAX IIs
and VAXstation II's with QVSS (VS II) or QDSS (GPX) displays;
the kernel includes support for these displays, courtesy of Digital
Equipment Corp.
In order to install the bootstrap on RD52/53/54 disks with
.IR disklabel (8),
the new /etc/disktab must be used,
or the block 0 bootstrap must be explictly listed as /usr/mdec/rdboot
(\fInot\fP raboot).
.\}
.PP
The order in which daemons are started by /etc/rc and /etc/rc.local
has changed, and network initialization has been split into /etc/netstart.
Look at the prototype files, and modify /etc/rc.local as necessary;
c.f. section 5.6.1.
.PP
\*(4B includes the Olson
timezone implementation, which uses timezone and daylight-savings-time
rules loaded from files in /etc/zoneinfo; see
.IR ctime (3)
and
.IR tzfile (5).
.PP
The type of the
.IR sprintf (3S)
function has been changed from \fIchar *\fP in 4.2BSD and 4.3BSD
to \fIint\fP as in the proposed ANSI C standard and in System V.
Programers are discouraged from using the return value from
.I sprintf
until this change is ubiquitous.
Fortunately, the previous return value from
.I sprintf
was essentially useless.
.PP
D 7
The ownership and modes of some of these directories have changed.
E 7
I 7
The ownership and modes of some directories have changed.
E 7
The \fIat\fP programs now run set-user-id ``root'' instead of ``daemon.''
Also, the uucp directory no longer needs to be publicly writable,
as \fItip\fP reverts to privileged status to remove its lock files.
After copying your version of /usr/spool, you should do:
.DS
\fB#\fP \fIchown \-R root /usr/spool/at\fP
\fB#\fP \fIchown \-R uucp.daemon /usr/spool/uucp\fP
\fB#\fP \fIchmod \-R o\-w /usr/spool/uucp\fP
.DE
.PP
The MAKEHOSTS file has moved from /usr/hosts to /usr.
.PP
The source versions of the manual pages have been moved from
/usr/man/man[1-8] to /usr/src/man, /usr/src/new/man, and /usr/src/local/man.
Local manual pages should be moved into their respective source code
directories, or into /usr/src/local/man/man[1-8], and Makefiles changed to
install the formatted manual pages into /usr/local/man/cat[1-8].  The shell
script /usr/man/manroff calls nroff with the standard manual arguments.  An 
example of installing a manual page might be:
.DS
\fB#\fP \fI/usr/man/manroff example.2 > example.0\fP
\fB#\fP \fIinstall -o bin -g bin -m 444 example.0 /usr/local/man/cat2\fP
.DE
.PP
Whatever else is left is likely to be site specific or require
careful scrutiny before placing in its eventual resting place.
Refer to the documentation and source code 
before arbitrarily overwriting a file.
E 11
I 11
D 24
The following two sections contain additional notes concerning
E 24
I 24
The following two sections contain additional notes about
E 24
changes in \*(4B that affect the installation of local files;
be sure to read them as well.
E 11
E 6
E 2
E 1
