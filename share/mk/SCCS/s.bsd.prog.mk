h11273
s 00002/00002/00199
d D 8.2 94/04/02 16:38:26 bostic 41 40
c core is now prog.core, not core.prog
e
s 00000/00000/00201
d D 8.1 93/07/19 09:38:27 bostic 40 39
c 4.4BSD snapshot (revision 8.1)
e
s 00001/00001/00200
d D 5.37 93/07/19 09:38:23 bostic 39 36
c add INSTALLFLAGS variable (for -f to install)
e
s 00000/00000/00201
d R 8.1 93/06/08 11:35:48 bostic 38 36
c 4.4BSD snapshot (revision 8.1)
e
s 00002/00000/00201
d R 5.37 93/05/19 17:14:57 bostic 37 36
c build tags 444
e
s 00002/00002/00199
d D 5.36 92/11/30 23:34:26 bostic 36 35
c make ctags work better when obj is a directory
e
s 00001/00001/00200
d D 5.35 92/08/26 09:13:13 bostic 35 34
c provide a way to not include the Makefile.inc above
e
s 00001/00001/00200
d D 5.34 92/08/25 15:57:24 bostic 34 33
c new RE package doesn't like random backslashes
e
s 00002/00002/00199
d D 5.33 92/07/29 14:38:41 bostic 33 32
c remove core.${PROG}, not core
e
s 00004/00000/00197
d D 5.32 92/07/27 09:36:35 bostic 32 31
c don't build man pages if NOMAN defined globally
e
s 00001/00000/00196
d D 5.31 92/04/08 08:22:21 bostic 31 30
c create libkvm
e
s 00003/00001/00193
d D 5.30 91/11/14 09:45:40 karels 30 29
c allow "all" target to be provided externally; fix comment
e
s 00002/00000/00192
d D 5.29 91/09/23 14:51:40 bostic 29 28
c if NOMAN is defined, need maninstall now
e
s 00001/00001/00191
d D 5.28 91/09/09 15:23:22 bostic 28 27
c don't need to use old nroff anymore
e
s 00017/00002/00175
d D 5.27 91/08/07 16:33:05 karels 27 26
c add manpages, objdir; make maninstall a separate target
e
s 00001/00001/00176
d D 5.26 91/06/25 12:31:58 bostic 26 25
c don't remove tags when doing cleandir (Mike)
e
s 00001/00001/00176
d D 5.25 91/05/02 13:41:27 bostic 25 24
c use the old nroff for now, until all the man pages converted
e
s 00001/00001/00176
d D 5.24 91/04/30 16:50:43 bostic 24 23
c groff doesn't like -h
e
s 00001/00001/00176
d D 5.23 91/02/01 14:43:15 bostic 23 22
c need a semi-colon before the done
e
s 00001/00001/00176
d D 5.22 91/01/19 19:08:49 bostic 22 21
c change all suffixes in the SRCS list to .o, for OBJS list
e
s 00006/00001/00171
d D 5.21 90/12/14 11:50:18 bostic 21 20
c make obj create /usr/obj directory as well
e
s 00001/00001/00171
d D 5.20 90/06/29 11:08:09 bostic 20 19
c move libc.a
e
s 00001/00000/00171
d D 5.19 90/06/24 15:13:29 bostic 19 18
c if SHAREDSTRINGS defined, clean up the "strings" file
e
s 00003/00001/00168
d D 5.18 90/06/23 15:22:31 bostic 18 17
c do mkdep -p for single modules
e
s 00014/00002/00155
d D 5.17 90/06/22 19:05:21 bostic 17 16
c checkpoint .mk files
e
s 00001/00001/00156
d D 5.16 90/05/29 19:31:50 bostic 16 15
c don't need full path for xstr
e
s 00002/00002/00155
d D 5.15 90/05/29 18:52:04 bostic 15 14
c make sure depend does sub directories
e
s 00007/00001/00150
d D 5.14 90/05/15 20:30:25 bostic 14 13
c don't do local dependency if PROG not defined
e
s 00002/00001/00149
d D 5.13 90/05/13 13:11:05 bostic 13 12
c make tags work for programs
e
s 00040/00015/00110
d D 5.12 90/05/11 12:10:06 bostic 12 11
c make prog specific, add LINKS, some rearrangement/cleanup
e
s 00002/00000/00123
d D 5.11 90/05/10 17:23:07 bostic 11 10
c add sccs id
e
s 00014/00002/00109
d D 5.10 90/05/10 17:21:03 bostic 10 9
c do bsd.global.mk inline
e
s 00007/00003/00104
d D 5.9 90/05/10 17:12:50 bostic 9 8
c minor cleanups to make man pages right
e
s 00025/00007/00082
d D 5.8 90/05/08 13:42:46 bostic 8 7
c checkpoint, the world rebuilds
e
s 00065/00210/00024
d D 5.7 90/05/04 09:41:00 bostic 7 6
c checkpoint...
e
s 00009/00006/00225
d D 5.6 90/03/17 15:17:12 bostic 6 5
c add .depend inclusion; fixes for object directory (add CURDIR)
e
s 00155/00164/00076
d D 5.5 90/03/16 12:01:28 bostic 5 4
c rework for pmake 2.1
e
s 00054/00039/00186
d D 5.4 89/09/25 17:17:22 bostic 4 3
c lots of rework should be much cleaner
e
s 00173/00073/00052
d D 5.3 89/09/25 12:41:56 bostic 3 2
c checkpoint -- comment, LINKS, lots of new stuff
e
s 00074/00056/00051
d D 5.2 89/09/22 15:15:58 bostic 2 1
c check point
e
s 00107/00000/00000
d D 5.1 89/09/21 21:45:10 bostic 1 0
c date and time created 89/09/21 21:45:10 by bostic
e
u
U
t
T
I 11
#	%W% (Berkeley) %G%

E 11
I 5
D 7
# A Makefile for the BSD source tree.
#
#	%W% (Berkeley) %G%
#
E 7
I 7
D 10
.include <bsd.global.mk>
E 7
E 5
I 1
D 2
# user defines:
#	SRCS		list of source files
#	PROGC		program consisting of a single .c module
#	PROGO		program consisting of multiple .c modules
#	SRCLIBS		list of libraries program depends on
#	LDLIBS		list of libraries for loader
E 2
I 2
D 3
DEPENDFILE=	.depend
E 3
I 3

E 10
D 5
MAKE=	pmake	# for now...
I 4
CPP=	newcpp
E 4

# libraries used for dependency lines
E 3
LIBUTIL=	/usr/lib/libutil.a
I 3
LIBMATH=	/usr/lib/libm.a
LIBKRB=		/usr/lib/libkrb.a
LIBDES=		/usr/lib/libdes.a
LIBCOMPAT=	/usr/lib/libcompat.a
E 3
E 2

I 2
D 3
.if defined(SUBDIR)
E 3
I 3
# any specified manual pages -- if none have been specified at this point,
# we make assumptions about what they are and what they're called.
MANALL=	${MAN1} ${MAN2} ${MAN3} ${MAN4} ${MAN5} ${MAN6} ${MAN7} ${MAN8}
E 3

E 5
D 3
MACHINE != machine
E 3
I 3
D 7
# user defines:
D 5
#	SUBDIR -- the list of subdirectories to be processed
E 5
I 5
#	BINDIR, BINGRP, BINMODE, BINOWN
#		binary target directory, group, mode, owner
#	CLEANFILES
#		list of files to be removed for the target clean; used,
#		for example, to specify .c's produced from .y's.
#	LDLIB	the list of libraries that the program loads, in the format
#		expected by the loader.
#	LINKS	list of binary links of the form "link target link target";
#		for example, "/bin/[ /usr/bin/test" would link /bin/[ to
#		/usr/bin/test"; not particularly labor saving, but prevents
#		needing your own install target.
#	MANDIR, MANMODE
#		manual page installation directory, mode
#	MLINKS	list of man page links of the form "link target link target",
#		with some trickiness so the suffix specifies the directory to
#		use.  For example, "a.1 b.2 c.3 d.4" would link ${MANDIR}1/a.0
#		to ${MANDIR}2/b.0 and ${MANDIR}3/c.0 to ${MANDIR}4/d.0.
#	PROG	program name
#	SHAREDSTRINGS
#		objects share strings using ${XSTR}
#	SRCS	list of .c sources if the program has multiple files.
#	SRCLIB	the list of libraries that the program depends on; normally
#		from the LIB* list in this file.
#	STRIP	strip flag
E 5
#
D 5
# if SUBDIR is set, we're in a makefile that processes subdirectories;
# for all the standard targets, change to the subdirectory and make the
# target.  If making one of the subdirectories, change to it and make
# the target "all".  Machine dependent subdirectories take precedence
# over standard subdirectories.
.if defined(SUBDIR)
E 3
D 4
all depend clean cleandir lint tags:
E 4
I 4
all depend clean cleandir lint install tags:
E 4
D 3
	cd ${SUBDIR}.${MACHINE}; pmake ${.TARGET}
E 3
I 3
	@for entry in ${SUBDIR}; do
D 4
		(echo  "==> $$entry"
E 4
I 4
		(echo "====> $$entry"
E 4
		if test -d $${entry}.${MACHINE}; then
			cd $${entry}.${MACHINE}
		else
			cd $${entry}
		fi
		${MAKE} ${.TARGET})
	done
E 5
I 5
# user macros:
#	STDALL	standard all target
#	STDCLEAN
#		standard clean target
#	STDCLEANDIR
#		standard cleandir target
#	STDDEPEND
#		standard depend target
#	STDLINT
#		standard lint target
#	STDINSTALL
#		standard install target
#	STDTAGS	standard tags target
E 5
E 3

D 3
.else
E 3
I 3
D 5
${SUBDIR}:
	@if test -d ${.TARGET}.${MACHINE}; then
		cd ${.TARGET}.${MACHINE}
	else
		cd ${.TARGET}
	fi
	${MAKE} all
E 5
I 5
# permit a hierarchy of Makefile include files
.if exists(../Make.include)
.include "../Make.include"
E 7
I 7
D 35
.if exists(${.CURDIR}/../Makefile.inc)
E 35
I 35
.if !defined(NOINCLUDE) && exists(${.CURDIR}/../Makefile.inc)
E 35
.include "${.CURDIR}/../Makefile.inc"
E 7
.endif
E 5
E 3

I 10
.SUFFIXES: .out .o .c .y .l .s .8 .7 .6 .5 .4 .3 .2 .1 .0

.8.0 .7.0 .6.0 .5.0 .4.0 .3.0 .2.0 .1.0:
D 17
	nroff -man -h ${.IMPSRC} > ${.TARGET}
E 17
I 17
D 24
	nroff -mandoc -h ${.IMPSRC} > ${.TARGET}
E 24
I 24
D 25
	nroff -mandoc ${.IMPSRC} > ${.TARGET}
E 25
I 25
D 28
	/usr/old/bin/nroff -mandoc ${.IMPSRC} > ${.TARGET}
E 28
I 28
	nroff -man ${.IMPSRC} > ${.TARGET}
E 28
E 25
E 24
E 17

CFLAGS+=${COPTS}

I 12
STRIP?=	-s

BINGRP?=	bin
BINOWN?=	bin
BINMODE?=	555

E 12
E 10
I 3
D 5
.else	# !SUBDIR
E 5
I 5
D 7
# name of the dependency file
DEPENDFILE=	.depend
I 6
.if exists(.depend)
.include ".depend"
.endif
E 7
I 7
D 20
LIBC?=		/lib/libc.a
E 20
I 20
LIBC?=		/usr/lib/libc.a
E 20
LIBCOMPAT?=	/usr/lib/libcompat.a
LIBCURSES?=	/usr/lib/libcurses.a
LIBDBM?=	/usr/lib/libdbm.a
LIBDES?=	/usr/lib/libdes.a
LIBL?=		/usr/lib/libl.a
LIBKDB?=	/usr/lib/libkdb.a
LIBKRB?=	/usr/lib/libkrb.a
I 31
LIBKVM?=	/usr/lib/libkvm.a
E 31
LIBM?=		/usr/lib/libm.a
LIBMP?=		/usr/lib/libmp.a
LIBPC?=		/usr/lib/libpc.a
LIBPLOT?=	/usr/lib/libplot.a
I 17
LIBRESOLV?=	/usr/lib/libresolv.a
E 17
LIBRPC?=	/usr/lib/sunrpc.a
LIBTERM?=	/usr/lib/libterm.a
LIBUTIL?=	/usr/lib/libutil.a
I 10

.if defined(SHAREDSTRINGS)
I 19
CLEANFILES+=strings
E 19
.c.o:
D 16
	${CC} -E ${CFLAGS} ${.IMPSRC} | /usr/bin/xstr -c -
E 16
I 16
	${CC} -E ${CFLAGS} ${.IMPSRC} | xstr -c -
E 16
	@${CC} ${CFLAGS} -c x.c -o ${.TARGET}
	@rm -f x.c
.endif
E 10
E 7
E 6
E 5

I 9
.if defined(PROG)
E 9
D 5
# user defines:
#	SHAREDSTRINGS -- boolean variable, if sharing strings in objects.
#
# if SHAREDSTRINGS is defined, use XSTR to build objects.
#
E 5
I 5
D 7
# standard libraries
LIBC=		/lib/libc.a
LIBCOMPAT=	/usr/lib/libcompat.a
LIBDES=		/usr/lib/libdes.a
LIBKRB=		/usr/lib/libkrb.a
LIBMATH=	/usr/lib/libm.a
LIBUTIL=	/usr/lib/libutil.a
E 7
I 7
.if defined(SRCS)
E 7

D 7
# read-only version of standard .c.o rule
READONLY: .USE
	${CC} ${CFLAGS} -c -R ${.IMPSRC}
E 7
I 7
D 22
OBJS+=	${SRCS:.c=.o}
E 22
I 22
OBJS+=  ${SRCS:R:S/$/.o/g}
E 22
E 7

D 7
# if the user defines SHAREDSTRINGS, they want objects to share strings.
# Turn off parallel makes (the strings file is single threaded) and
# rewrite the .c.o rule to use XSTR to build the objects.
E 5
.if defined(SHAREDSTRINGS)
.NOTPARALLEL:
D 5
XSTR=	xstr
E 5
I 5
XSTR=/usr/bin/xstr
E 5
.c.o:
D 5
	${CC} -E ${.INCLUDES} ${CFLAGS} ${.IMPSRC} | ${XSTR} -c -
	@${CC} ${.INCLUDES} ${CFLAGS} -c x.c -o ${.TARGET}
E 5
I 5
	${CC} -E ${CFLAGS} ${.IMPSRC} | ${XSTR} -c -
	@${CC} ${CFLAGS} -c x.c -o ${.TARGET}
E 5
	@rm -f x.c
.endif
E 7
I 7
${PROG}: ${OBJS} ${LIBC} ${DPADD}
	${CC} ${LDFLAGS} -o ${.TARGET} ${OBJS} ${LDADD}
E 7

D 5
# the default target is all
E 5
I 5
D 7
# the default target.
E 5
E 3
.MAIN: all
E 7
I 7
D 9
.else
E 9
I 9
D 30
.else defined(PROG)
E 30
I 30
.else defined(SRCS)
E 30
E 9
E 7
I 3

D 5
# user defines:
#	PROGC	-- the name of a program composed of a single source module
#	PROGO	-- the name of a program composed of several object modules
#	SRCLIB	-- the list of libraries that the program depends on;
#		   normally from the LIB* list at the top of this file.
#	LDLIB	-- the list of libraries that the program loads, in the
#		   format expected by the loader.
E 5
I 5
D 7
# manual pages -- if the Makefile doesn't specify one, assume that they're
# named in a standard way, i.e. it's in section 1 with the same name as the
# program.
MANALL=	${MAN1} ${MAN2} ${MAN3} ${MAN4} ${MAN5} ${MAN6} ${MAN7} ${MAN8}
E 7
I 7
SRCS= ${PROG}.c
E 7
E 5

E 3
E 2
D 5
all: ${PROGC} ${PROGO}
E 5
I 5
D 7
# In the BSD source tree, each program Makefile should specify PROG, the
# name of the program.
all: ${PROG}
E 7
I 7
${PROG}: ${SRCS} ${LIBC} ${DPADD}
	${CC} ${CFLAGS} -o ${.TARGET} ${.CURDIR}/${SRCS} ${LDADD}
E 7
E 5

I 18
MKDEP=	-p

E 18
I 3
D 5
# if the program is composed of a single source module, that module is
# C source with the same name as the program.  If no manual pages have
# been defined, it's in section 1 with the same name as the program.
E 3
.if defined(PROGC)
SRCS=	${PROGC}.c
E 5
I 5
D 7
.if defined(SRCS)
E 7
I 7
.endif
E 7
E 5

I 3
D 4
.if !defined(MANALL)
E 4
I 4
D 5
.if !defined(MAN1) && !defined(MAN2) && !defined(MAN3) && !defined(MAN4) && !defined(MAN5) && !defined(MAN6) && !defined(MAN7) && !defined(MAN8)
E 4
MAN1=	${PROGC}.0
E 5
I 5
D 7
# if the program is composed of several object modules, the modules are
# the list of sources with the .o's translated to .c's.
OBJS=	${SRCS:.c=.o}

.if !defined(MAN1) && !defined(MAN2) && !defined(MAN3) && !defined(MAN4) && \
	!defined(MAN5) && !defined(MAN6) && !defined(MAN7) && !defined(MAN8)
E 7
I 7
.if	!defined(MAN1) && !defined(MAN2) && !defined(MAN3) && \
	!defined(MAN4) && !defined(MAN5) && !defined(MAN6) && \
	!defined(MAN7) && !defined(MAN8) && !defined(NOMAN)
E 7
MAN1=	${PROG}.0
E 5
.endif
I 9
.endif
I 32
.if !defined(NOMAN)
E 32
E 9
I 7
MANALL=	${MAN1} ${MAN2} ${MAN3} ${MAN4} ${MAN5} ${MAN6} ${MAN7} ${MAN8}
I 32
.else
MANALL=
.endif
E 32
I 27
manpages: ${MANALL}
E 27
E 7

E 3
D 2
.if !defined(MAN1)
MAN1=	${PROGC}.0
.endif
E 2
I 2
D 5
${PROGC}: ${SRCS} ${LIBC} ${SRCLIB}
D 3
	${CC} -o ${.TARGET} ${SRCS} ${LDLIB}
E 3
I 3
	${CC} ${CFLAGS} -o ${.TARGET} ${SRCS} ${LDLIB}
E 5
I 5
D 7
${PROG}: ${OBJS} ${LIBC} ${SRCLIB}
	${CC} ${LDFLAGS} -o ${.TARGET} ${OBJS} ${LDLIB}
E 7
I 7
D 12
PROGSUBDIR: .USE
E 12
I 12
_PROGSUBDIR: .USE
E 12
.if defined(SUBDIR) && !empty(SUBDIR)
	@for entry in ${SUBDIR}; do \
D 8
		(echo "===> $$entry"; \
E 8
I 8
D 12
		(echo "===> ${PROG}/$$entry"; \
E 12
I 12
		(echo "===> $$entry"; \
E 12
E 8
		if test -d ${.CURDIR}/$${entry}.${MACHINE}; then \
			cd ${.CURDIR}/$${entry}.${MACHINE}; \
		else \
			cd ${.CURDIR}/$${entry}; \
		fi; \
D 12
		${MAKE} ${.TARGET}) \
E 12
I 12
D 14
		${MAKE} ${.TARGET:realinstall=install}) \
E 14
I 14
D 23
		${MAKE} ${.TARGET:S/realinstall/install/:S/.depend/depend/}) \
E 23
I 23
		${MAKE} ${.TARGET:S/realinstall/install/:S/.depend/depend/}); \
E 23
E 14
E 12
	done
.endif
E 7
E 5
E 3
E 2

I 30
.if !target(all)
E 30
D 2
${PROGC}: ${SRCS} ${LIBC} ${SRCLIBS}
	${CC} -o ${.TARGET} ${.ALLSRC} ${LDLIBS}

depend: ${SRCS}
	mkdep -p ${CFLAGS} ${.ALLSRC}

E 2
D 3
clean:
	rm -f core ${PROGC}
D 2
.else
OBJS=	${SRCS:.c=.o}
E 2

E 3
D 2
.if !defined(MAN1)
MAN1=	${PROGO}.0
E 2
I 2
D 4
depend: ${SRCS}
	mkdep -p ${CFLAGS:M-[ID]*} ${.INCLUDES} ${.ALLSRC}
E 4
I 4
D 7
.depend: ${SRCS}
D 5
	set -
	${CPP} -M ${CFLAGS:M-[ID]*} ${.INCLUDES} ${.ALLSRC} |
		sed "s/^/${PROGC}: /" > ${DEPENDFILE}.new
	mv ${DEPENDFILE}.new ${DEPENDFILE}
E 5
I 5
D 6
	@set ${OBJS}
	@for entry in ${.ALLSRC}; do
E 6
I 6
	@set ${OBJS}; \
	for entry in ${.ALLSRC}; do \
E 6
		echo "$$1:" \
D 6
		    `${CPP} -M ${CFLAGS:M-[ID]*} ${.INCLUDES} $$entry`
		shift
E 6
I 6
		    `${CPP} -M ${CFLAGS:M-[ID]*} ${.INCLUDES} $$entry`; \
		shift; \
E 6
	done > ${DEPENDFILE}
E 7
I 7
.MAIN: all
D 12
all: ${PROG} ${MANALL} PROGSUBDIR
E 12
I 12
all: ${PROG} ${MANALL} _PROGSUBDIR
I 30
.endif
E 30
E 12
E 7
E 5
E 4

E 2
D 3
.endif
E 3
I 3
D 5
.endif	# PROGC
E 5
I 5
D 7
${OBJS}: ${.PREFIX}.c
E 5
E 3

I 3
D 5
# if the program is composed of several object modules, the modules are
# the list of sources with the .o's translated to .c's.  If no manual
# pages have been defined, it's in section 1 with the same name as the
# program.  Objects depend on their C source counterparts.
E 3
D 2
${PROGO}: ${OBJS} ${LIBC} ${SRCLIBS}
	${CC} -o ${.TARGET} ${OBJS} ${LDLIBS}
E 2
I 2
.if defined(PROGO)
E 5
I 5
.else
E 5
I 3

E 3
D 5
OBJS=	${SRCS:.c=.o}
E 5
I 5
SRCS= ${PROG}.c
E 5
E 2

I 3
D 4
.if !defined(MANALL)
E 4
I 4
D 5
.if !defined(MAN1) && !defined(MAN2) && !defined(MAN3) && !defined(MAN4) && !defined(MAN5) && !defined(MAN6) && !defined(MAN7) && !defined(MAN8)
E 4
MAN1=	${PROGO}.0
E 5
I 5
.if !defined(MAN1) && !defined(MAN2) && !defined(MAN3) && !defined(MAN4) && \
	!defined(MAN5) && !defined(MAN6) && !defined(MAN7) && !defined(MAN8)
MAN1=	${PROG}.0
E 7
I 7
.if !target(clean)
D 12
clean: PROGSUBDIR
E 12
I 12
clean: _PROGSUBDIR
E 12
D 33
	rm -f a.out [Ee]rrs mklog core ${PROG} ${OBJS} ${CLEANFILES}
E 33
I 33
D 41
	rm -f a.out [Ee]rrs mklog core.${PROG} ${PROG} ${OBJS} ${CLEANFILES}
E 41
I 41
	rm -f a.out [Ee]rrs mklog ${PROG}.core ${PROG} ${OBJS} ${CLEANFILES}
E 41
E 33
E 7
E 5
.endif

E 3
D 2
{OBJS}: ${.PREFIX}.c
E 2
I 2
D 5
${PROGO}: ${OBJS} ${LIBC} ${SRCLIB}
D 3
	${CC} -o ${.TARGET} ${OBJS} ${LDLIB}
E 3
I 3
	${CC} ${LDFLAGS} -o ${.TARGET} ${OBJS} ${LDLIB}
E 5
I 5
D 7
${PROG}: ${SRCS} ${LIBC} ${SRCLIB}
D 6
	${CC} ${CFLAGS} -o ${.TARGET} ${SRCS} ${LDLIB}
E 6
I 6
	${CC} ${CFLAGS} -o ${.TARGET} ${CURDIR}/${SRCS} ${LDLIB}
E 7
I 7
D 8
STDCLEANDIR: PROGSUBDIR
E 8
I 8
.if !target(cleandir)
D 12
cleandir: PROGSUBDIR
E 12
I 12
cleandir: _PROGSUBDIR
E 12
E 8
D 33
	rm -f a.out [Ee]rrs mklog core ${PROG} ${OBJS} ${CLEANFILES}
E 33
I 33
D 41
	rm -f a.out [Ee]rrs mklog core.${PROG} ${PROG} ${OBJS} ${CLEANFILES}
E 41
I 41
	rm -f a.out [Ee]rrs mklog ${PROG}.core ${PROG} ${OBJS} ${CLEANFILES}
E 41
E 33
D 26
	rm -f .depend ${.CURDIR}/tags ${MANALL}
E 26
I 26
	rm -f .depend ${MANALL}
E 26
I 8
.endif
E 8
E 7
E 6
E 5
E 3
E 2

D 4
depend: ${SRCS}
D 2
	mkdep ${CFLAGS} ${.ALLSRC}
E 2
I 2
	mkdep ${CFLAGS:M-[ID]*} ${.INCLUDES} ${.ALLSRC}
E 4
I 4
D 7
.depend: ${SRCS}
D 5
	set -
	set ${OBJS}
	rm -f ${DEPENDFILE}.new
	for entry in ${.ALLSRC}; do
		${CPP} -M ${CFLAGS:M-[ID]*} ${.INCLUDES} $$entry |
			sed "s/^/$$1: /" >> ${DEPENDFILE}.new
		shift
	done
	mv ${DEPENDFILE}.new ${DEPENDFILE}
E 5
I 5
D 6
	echo "${PROG}:" \
E 6
I 6
	@echo "${PROG}:" \
E 6
	    `${CPP} -M ${CFLAGS:M-[ID]*} ${.INCLUDES} ${.ALLSRC}` \
		    > ${DEPENDFILE}
E 7
I 7
# some of the rules involve .h sources, so remove them from mkdep line
D 8
STDDEPEND: ${SRCS} PROGSUBDIR
E 8
I 8
.if !target(depend)
D 15
depend: .depend
D 12
.depend: ${SRCS} PROGSUBDIR
E 12
I 12
.depend: ${SRCS} _PROGSUBDIR
E 15
I 15
depend: .depend _PROGSUBDIR
.depend: ${SRCS}
E 15
I 14
.if defined(PROG)
E 14
E 12
E 8
D 18
	mkdep ${CFLAGS:M-[ID]*} ${.ALLSRC:M*.c}
E 18
I 18
	mkdep ${MKDEP} ${CFLAGS:M-[ID]*} ${.ALLSRC:M*.c}
E 18
I 8
.endif
I 14
.endif
E 14
E 8
E 7
E 5
E 4
E 2

D 3
clean:
	rm -f ${OBJS} core ${PROGO}
I 2

E 3
D 5
${OBJS}: ${.PREFIX}.c
E 5
I 5
D 7
.endif	# defined(SRCS)
E 5

E 2
D 3
.endif
E 3
I 3
D 5
.endif	# PROGO
E 3

E 5
I 5
# standard targets
E 5
I 4
depend: .depend

E 4
D 2
# user defines:
#	MAN1		list of man targets for section 1
#	...
#	MAN8		list of man targets for section 8
MANALL=	${MAN1} ${MAN2} ${MAN3} ${MAN4} ${MAN5} ${MAN6} ${MAN7} ${MAN8}
E 2
I 2
D 3
.if !defined(MAN1)
MAN1=	${MDIR1} ${PROGC}.0
.endif
E 3
I 3
D 5
# user defines:
#	CLEANFILES	-- list of files to be removed for the target clean;
#			   used, for example, to specify .c's produced from
#			   .y's.
D 4
JUNKFILES=	Errs errs mklog core
E 4
I 4
JUNKFILES=	a.out Errs errs mklog core
E 4
clean:
D 4
	rm -f ${JUNKFILE} ${PROGC} ${PROGO} ${OBJS} ${CLEANFILES}
E 4
I 4
	rm -f ${PROGC} ${PROGO} ${OBJS} ${CLEANFILES} ${JUNKFILES}
E 5
I 5
STDCLEAN: .USE
	rm -f a.out Errs errs mklog core ${CLEANFILES} ${PROG} ${OBJS}
E 5
E 4
E 3
E 2

I 3
D 4
DEPENDFILE=	.depend
E 4
D 5
TAGSFILE=	tags
E 3
cleandir: clean
E 5
I 5
clean: STDCLEAN

STDCLEANDIR: .USE
E 5
	rm -f ${MANALL} ${TAGSFILE} ${DEPENDFILE}

I 2
D 5
LINTFLAGS=	-chapbx
lint: ${SRCS}
E 5
I 5
cleandir: clean STDCLEANDIR

LINTFLAGS=-chapbx
STDLINT: .USE
E 5
	lint ${LINTFLAGS} ${CFLAGS} ${.ALLSRC}

D 3
TAGSFILE=	tags
E 3
D 5
tags: ${SRCS}
E 5
I 5
lint: ${SRCS} STDLINT

TAGSFILE=tags
STDTAGS: .USE
E 5
	ctags ${.ALLSRC}

E 2
D 3
STRIP=		-s
BINMODE=	755
DEFOWN=		bin
DEFGRP=		bin
MANMODE=	444
I 2
MDIR1=		/usr/man/cat1
MDIR2=		/usr/man/cat2
MDIR3=		/usr/man/cat3
MDIR4=		/usr/man/cat4
MDIR5=		/usr/man/cat5
MDIR6=		/usr/man/cat6
MDIR7=		/usr/man/cat7
MDIR8=		/usr/man/cat8
MANALL=	${MAN1} ${MAN2} ${MAN3} ${MAN4} ${MAN5} ${MAN6} ${MAN7} ${MAN8}
E 3
I 3
D 5
# user defines:
D 4
#	MDIR	-- default manual page installtion directory
E 4
I 4
#	MDIR	-- default manual page installation directory
E 4
#	MANMODE	-- default manual page installation mode
#	STRIP	-- default strip flag
#	BINMODE	-- default binary installation mode
#	BINOWN	-- default binary owner
#	BINGRP	-- default binary group
D 4
MDIR?=		/usr/man/cat
E 4
I 4
MDIR?=		/usr/share/man/cat
E 5
I 5
tags: ${SRCS} STDTAGS

MANDIR?=	/usr/share/man/cat
E 5
E 4
MANMODE?=	444
STRIP?=		-s
BINMODE?=	755
BINOWN?=	bin
BINGRP?=	bin
E 3
E 2

I 3
# install target -- creates manual pages, then installs the binaries,
D 5
# manual pages, and manual page links.
E 3
install: ${MANALL}
E 5
I 5
# links, manual pages, and manual page links.
STDINSTALL: .USE
E 7
I 7
D 8
STDINSTALL: PROGSUBDIR
E 8
I 8
.if !target(install)
.if !target(beforeinstall)
beforeinstall:
.endif
I 12
.if !target(afterinstall)
afterinstall:
.endif
E 12

D 12
realinstall: beforeinstall PROGSUBDIR
E 12
I 12
realinstall: _PROGSUBDIR
.if defined(PROG)
E 12
E 8
E 7
E 5
D 3
	install ${STRIP} -o ${DEFOWN} -g ${DEFGRP} -m ${BINMODE} \
E 3
I 3
	install ${STRIP} -o ${BINOWN} -g ${BINGRP} -m ${BINMODE} \
E 3
D 2
	    ${PROGC} ${PROGO} ${DESTDIR}/${DIR}
E 2
I 2
D 5
	    ${PROGC} ${PROGO} ${DESTDIR}${DIR}
E 5
I 5
D 39
	    ${PROG} ${DESTDIR}${BINDIR}
E 39
I 39
	    ${INSTALLFLAGS} ${PROG} ${DESTDIR}${BINDIR}
E 39
I 12
.endif
E 12
E 5
E 2
D 7
.if defined(MAN1)
D 3
	install -c -o ${DEFOWN} -g ${DEFGRP} -m ${MANMODE} ${MAN1} \
D 2
	    ${DESTDIR}/usr/cat1
.endif
E 2
I 2
	    ${DESTDIR}${MDIR1}
.if defined(LINKS1)
	rm -f ${DESTDIR}${MDIR1}/${LINKS1}
	for i in ${LINKS1}; do
		ln ${DESTDIR}${MDIR1}/${MAN1} ${DESTDIR}${MDIR1}/$$i
	done
.endif	# LINKS1
.endif	# MAN1
E 3
I 3
	install -c -o ${BINOWN} -g ${BINGRP} -m ${MANMODE} ${MAN1} \
D 5
	    ${DESTDIR}${MDIR}1
E 5
I 5
	    ${DESTDIR}${MANDIR}1
E 7
I 7
.if defined(HIDEGAME)
	(cd ${DESTDIR}/usr/games; rm -f ${PROG}; ln -s dm ${PROG}; \
	    chown games.bin ${PROG})
E 7
E 5
.endif
I 12
.if defined(LINKS) && !empty(LINKS)
	@set ${LINKS}; \
	while test $$# -ge 2; do \
		l=${DESTDIR}$$1; \
		shift; \
		t=${DESTDIR}$$1; \
		shift; \
		echo $$t -\> $$l; \
		rm -f $$t; \
		ln $$l $$t; \
	done; true
.endif
E 12
E 3
E 2
D 7
.if defined(MAN2)
D 3
	install -c -o ${DEFOWN} -g ${DEFGRP} -m ${MANMODE} ${MAN2} \
D 2
	    ${DESTDIR}/usr/cat2
.endif
E 2
I 2
	    ${DESTDIR}${MDIR2}
.endif	# MAN2
E 3
I 3
	install -c -o ${BINOWN} -g ${BINGRP} -m ${MANMODE} ${MAN2} \
D 5
	    ${DESTDIR}${MDIR}2
E 5
I 5
	    ${DESTDIR}${MANDIR}2
E 5
.endif
E 3
E 2
.if defined(MAN3)
D 3
	install -c -o ${DEFOWN} -g ${DEFGRP} -m ${MANMODE} ${MAN3} \
D 2
	    ${DESTDIR}/usr/cat3
.endif
E 2
I 2
	    ${DESTDIR}${MDIR3}
.endif	# MAN3
E 3
I 3
	install -c -o ${BINOWN} -g ${BINGRP} -m ${MANMODE} ${MAN3} \
D 5
	    ${DESTDIR}${MDIR}3
E 5
I 5
	    ${DESTDIR}${MANDIR}3
E 5
.endif
E 3
E 2
.if defined(MAN4)
D 3
	install -c -o ${DEFOWN} -g ${DEFGRP} -m ${MANMODE} ${MAN4} \
D 2
	    ${DESTDIR}/usr/cat4
.endif
E 2
I 2
	    ${DESTDIR}${MDIR4}
.endif	# MAN4
E 3
I 3
	install -c -o ${BINOWN} -g ${BINGRP} -m ${MANMODE} ${MAN4} \
D 5
	    ${DESTDIR}${MDIR}4
E 5
I 5
	    ${DESTDIR}${MANDIR}4
E 5
.endif
E 3
E 2
.if defined(MAN5)
D 3
	install -c -o ${DEFOWN} -g ${DEFGRP} -m ${MANMODE} ${MAN5} \
D 2
	    ${DESTDIR}/usr/cat5
.endif
E 2
I 2
	    ${DESTDIR}${MDIR5}
.endif	# MAN5
E 3
I 3
	install -c -o ${BINOWN} -g ${BINGRP} -m ${MANMODE} ${MAN5} \
D 5
	    ${DESTDIR}${MDIR}5
E 5
I 5
	    ${DESTDIR}${MANDIR}5
E 5
.endif
E 3
E 2
.if defined(MAN6)
D 3
	install -c -o ${DEFOWN} -g ${DEFGRP} -m ${MANMODE} ${MAN6} \
D 2
	    ${DESTDIR}/usr/cat6
.endif
E 2
I 2
	    ${DESTDIR}${MDIR6}
.endif	# MAN6
E 3
I 3
	install -c -o ${BINOWN} -g ${BINGRP} -m ${MANMODE} ${MAN6} \
D 5
	    ${DESTDIR}${MDIR}6
E 5
I 5
	    ${DESTDIR}${MANDIR}6
E 5
.endif
E 3
E 2
.if defined(MAN7)
D 3
	install -c -o ${DEFOWN} -g ${DEFGRP} -m ${MANMODE} ${MAN7} \
D 2
	    ${DESTDIR}/usr/cat7
.endif
E 2
I 2
	    ${DESTDIR}${MDIR7}
.endif	# MAN7
E 3
I 3
	install -c -o ${BINOWN} -g ${BINGRP} -m ${MANMODE} ${MAN7} \
D 5
	    ${DESTDIR}${MDIR}7
E 5
I 5
	    ${DESTDIR}${MANDIR}7
E 5
.endif
E 3
E 2
.if defined(MAN8)
D 3
	install -c -o ${DEFOWN} -g ${DEFGRP} -m ${MANMODE} ${MAN8} \
D 2
	    ${DESTDIR}/usr/cat8
E 2
I 2
	    ${DESTDIR}${MDIR8}
.endif	# MAN8
E 3
I 3
	install -c -o ${BINOWN} -g ${BINGRP} -m ${MANMODE} ${MAN8} \
D 5
	    ${DESTDIR}${MDIR}8
E 5
I 5
	    ${DESTDIR}${MANDIR}8
E 5
E 3
E 2
.endif
D 3

D 2
LINTFLAGS=	-chapbx
lint: ${SRCS}
	lint ${LINTFLAGS} ${CFLAGS} ${.ALLSRC}

TAGSFILE=	tags
tags: ${SRCS}
	ctags ${.ALLSRC}

.include <template.mk>

.if exists(.depend)
.include ".depend"
E 2
I 2
.if defined(SHAREDSTRINGS)
.NOTPARALLEL:
XSTR=	xstr
.c.o:
	${CC} -E ${.INCLUDES} ${CFLAGS} ${.IMPSRC} | ${XSTR} -c -
	@${CC} ${.INCLUDES} ${CFLAGS} -c x.c -o ${.TARGET}
	@rm -f x.c
E 2
.endif
E 3
I 3
D 5
# user defines:
D 4
#	LINKS	-- list of manual page links of the form "link target
E 4
I 4
#	LINKS	-- list of binary links of the form "link target
#		   link target"; for example, "/bin/[ /usr/bin/test"
#		   would link /bin/[ to /usr/bin/test"; not particularly
#		   labor saving, but prevents needing your own install
#		   target.
#	MLINKS	-- list of manual page linkes of the form "link target
E 4
#		   link target"; for example, "a.1 b.2 c.3 d.4" would
#		   link ${MDIR}1/a.0 to ${MDIR}2/b.0 and ${MDIR}3/c.0
#		   to ${MDIR}4/d.0.
E 5
.if defined(LINKS)
D 4
	@set ${LINKS} 
E 4
I 4
D 5
	@set ${LINKS}
E 4
	@while :; do
		if `test $$# -lt 2`; then
			break;
		fi
I 4
		t=$$1
		shift
		l=$$1
		shift
		echo $$l -\> $$t
		rm -f $$t
		ln ${DESTDIR}$$l ${DESTDIR}$$t
	done
E 5
I 5
	@set ${LINKS}; \
	while test $$# -ge 2; do \
		t=$$1; \
		shift; \
		l=$$1; \
		shift; \
		echo $$l -\> $$t; \
		rm -f $$t; \
		ln ${DESTDIR}$$l ${DESTDIR}$$t; \
	done; true
E 5
.endif	# LINKS
.if defined(MLINKS)
D 5
	@set ${MLINKS}
	@while :; do
		if `test $$# -lt 2`; then
			break;
		fi
E 4
		name=$$1
D 4
		case $$name in
			*.1)	dir=${MDIR}1;;
			*.2)	dir=${MDIR}2;;
			*.3)	dir=${MDIR}3;;
			*.4)	dir=${MDIR}4;;
			*.5)	dir=${MDIR}5;;
			*.6)	dir=${MDIR}6;;
			*.7)	dir=${MDIR}7;;
			*.8)	dir=${MDIR}8;;
		esac
		t=${DESTDIR}$${dir}/`expr $$name : '\([^\.]*\)'`.0
E 4
		shift
I 4
		dir=${MDIR}`expr $$name : '[^\.]*\.\(.*\)'`
		t=${DESTDIR}$${dir}/`expr $$name : '\([^\.]*\)'`.0
E 4
		name=$$1
D 4
		case $$name in
			*.1)	dir=${MDIR}1;;
			*.2)	dir=${MDIR}2;;
			*.3)	dir=${MDIR}3;;
			*.4)	dir=${MDIR}4;;
			*.5)	dir=${MDIR}5;;
			*.6)	dir=${MDIR}6;;
			*.7)	dir=${MDIR}7;;
			*.8)	dir=${MDIR}8;;
		esac
E 4
I 4
		shift
		dir=${MDIR}`expr $$name : '[^\.]*\.\(.*\)'`
E 4
		l=${DESTDIR}$${dir}/`expr $$name : '\([^\.]*\)'`.0
D 4
		rm -f $$t
E 4
		echo $$l -\> $$t
I 4
		rm -f $$t
E 4
		ln $$l $$t
D 4
		shift
E 4
	done
E 5
I 5
	@set ${MLINKS}; \
	while test $$# -ge 2; do \
		name=$$1; \
		shift; \
		dir=${MANDIR}`expr $$name : '[^\.]*\.\(.*\)'`; \
		t=${DESTDIR}$${dir}/`expr $$name : '\([^\.]*\)'`.0; \
		name=$$1; \
		shift; \
		dir=${MANDIR}`expr $$name : '[^\.]*\.\(.*\)'`; \
		l=${DESTDIR}$${dir}/`expr $$name : '\([^\.]*\)'`.0; \
		echo $$l -\> $$t; \
		rm -f $$t; \
		ln $$l $$t; \
	done; true
E 5
D 4
.endif	# LINKS
E 4
I 4
.endif	# MLINKS
E 7
E 4
D 5
.endif	# SUBDIR
E 5
I 5

D 7
install: ${MANALL} STDINSTALL
E 7
I 7
D 8
STDLINT: PROGSUBDIR
E 8
I 8
D 9
install: afterinstall
afterinstall: realinstall MANINSTALL
E 9
I 9
D 12
install: afterinstall PROGSUBDIR
afterinstall: realinstall maninstall
.else
install: PROGSUBDIR
E 12
I 12
D 27
install: maninstall
maninstall: afterinstall
E 27
I 27
install: afterinstall maninstall
E 27
afterinstall: realinstall
realinstall: beforeinstall
E 12
E 9
.endif

.if !target(lint)
D 12
lint: ${SRCS} PROGSUBDIR
E 12
I 12
lint: ${SRCS} _PROGSUBDIR
I 14
.if defined(PROG)
E 14
E 12
E 8
	@${LINT} ${LINTFLAGS} ${CFLAGS} ${.ALLSRC} | more 2>&1
I 8
.endif
I 14
.endif
E 14
E 8

I 17
.if !target(obj)
.if defined(NOOBJ)
obj: _PROGSUBDIR
.else
obj: _PROGSUBDIR
	@cd ${.CURDIR}; rm -rf obj; \
	here=`pwd`; dest=/usr/obj/`echo $$here | sed 's,/usr/src/,,'`; \
D 21
	echo "$$here -> $$dest"; ln -s $$dest obj
E 21
I 21
	echo "$$here -> $$dest"; ln -s $$dest obj; \
I 27
	if test -d /usr/obj -a ! -d $$dest; then \
		mkdir -p $$dest; \
	else \
		true; \
	fi;
.endif
.endif

.if !target(objdir)
.if defined(NOOBJ)
objdir: _PROGSUBDIR
.else
objdir: _PROGSUBDIR
	@cd ${.CURDIR}; \
	here=`pwd`; dest=/usr/obj/`echo $$here | sed 's,/usr/src/,,'`; \
E 27
	if test -d /usr/obj -a ! -d $$dest; then \
		mkdir -p $$dest; \
	else \
		true; \
	fi;
E 21
.endif
.endif

E 17
D 8
STDTAGS: PROGSUBDIR
	tags -f ${.CURDIR}/tags ${.ALLSRC}
E 8
I 8
.if !target(tags)
D 12
tags: ${SRCS} PROGSUBDIR
E 12
I 12
tags: ${SRCS} _PROGSUBDIR
I 14
.if defined(PROG)
E 14
E 12
D 13
	ctags -f ${.CURDIR}/tags ${.ALLSRC}
E 13
I 13
D 17
	cd ${.CURDIR}; ctags -f /dev/stdout ${.ALLSRC} | \
E 17
I 17
D 36
	-cd ${.CURDIR}; ctags -f /dev/stdout ${.ALLSRC} | \
E 17
D 34
	    sed "s;\${.CURDIR}/;;" > tags
E 34
I 34
	    sed "s;${.CURDIR}/;;" > tags
E 36
I 36
	-ctags -f /dev/stdout ${.ALLSRC} | \
	    sed "s;${.CURDIR}/;;" > ${.CURDIR}/tags
E 36
E 34
I 14
.endif
E 14
E 13
.endif
E 8

D 12
.include <bsd.own.mk>
E 12
I 12
.if !defined(NOMAN)
.include <bsd.man.mk>
I 29
.else
maninstall:
E 29
.endif
E 12
E 7
E 5
E 3
E 1
