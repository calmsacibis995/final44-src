h29809
s 00024/6234/4294966234
 83/01/01 13:18:43 sam 2 1
c rewrite to use rename and file locking 
e
s 00174/00000/00000
d D 4.1 80/10/01 17:27:43 bill 1 0
c date and time created 80/10/01 17:27:43 by bill
e
u
U
t
T
I 1
D 2
static char *sccsid = "%W% (Berkeley) %G%";
E 2
I 2
#ifndef lint
static char sccsid[] = "%W% (Berkeley) %G%";
#endif

E 2
/*
 * enter a password in the password file
 * this program should be suid with owner
 * with an owner with write permission on /etc/passwd
 */
I 2
#include <sys/file.h>

E 2
#include <stdio.h>
#include <signal.h>
#include <pwd.h>
I 2
#include <errno.h>
E 2

char	passwd[] = "/etc/passwd";
char	temp[]	 = "/etc/ptmp";
struct	passwd *pwd;
struct	passwd *getpwent();
int	endpwent();
char	*strcpy();
char	*crypt();
char	*getpass();
char	*getlogin();
char	*pw;
char	pwbuf[10];
D 2
char	buf[BUFSIZ];
E 2
I 2
extern	int errno;
E 2

main(argc, argv)
D 2
char *argv[];
E 2
I 2
	char *argv[];
E 2
{
	char *p;
	int i;
	char saltc[2];
	long salt;
D 2
	int u,fi,fo;
E 2
I 2
	int u;
E 2
	int insist;
	int ok, flags;
D 2
	int c;
	int pwlen;
E 2
I 2
	int c, pwlen, fd;
E 2
	FILE *tf;
	char *uname;

	insist = 0;
D 2
	if(argc < 2) {
E 2
I 2
	if (argc < 2) {
E 2
		if ((uname = getlogin()) == NULL) {
			printf ("Usage: passwd user\n");
D 2
			goto bex;
		} else {
			printf("Changing password for %s\n", uname);
E 2
I 2
			exit(1);
E 2
		}
D 2
	} else {
E 2
I 2
		printf("Changing password for %s\n", uname);
	} else
E 2
		uname = argv[1];
D 2
	}
	while(((pwd=getpwent()) != NULL)&&(strcmp(pwd->pw_name,uname)!=0));
E 2
I 2
	while (((pwd = getpwent()) != NULL) && strcmp(pwd->pw_name, uname))
		;
E 2
	u = getuid();
D 2
	if((pwd==NULL) || (u!=0 && u != pwd->pw_uid))
		{
E 2
I 2
	if (pwd == NULL || (u != 0 && u != pwd->pw_uid)) {
E 2
		printf("Permission denied.\n");
D 2
		goto b%x;
		}
E 2
I 2
		exit(1);
	}
E 2
	endpwent();
	if (pwd->pw_passwd[0] && u != 0) {
		strcpy(pwbuf, getpass("Old password:"));
D 2
		pw = #sypt(pwbuf, pwd->pw_passwd);
		if(strcmp(pw, pwd->pw_passwd) != 0) {
E 2
I 2
		pw = crypt(pwbuf, pwd->pw_passwd);
		if (strcmp(pw, pwd->pw_passwd) != 0) {
E 2
			printf("Sorry.\n");
D 2
			goto bex;
E 2
I 2
			exit(1);
E 2
		}
	}
D 2
tryagn:
E 2
I 2
tryagain:
E 2
	strcpy(pwbuf, getpass("New password:"));
	pwlen = strlen(pwbuf);
	if (pwlen == 0) {
D 2
		printf("Password unchanged.\n")		goto bex;
	}
	ok = 0;
	flags = 0;
	p = pwbuf;
	while(c = *p++){
		if(c>='a' && c<='z') flags |= 2;
		else if(c>='A' && c<='Z') flags |= 4;
		else if(c>='0' && c<='9') flags |= 1;
		else flags |= 8;
	}
	if(flags >=7 && pwlen>= 4) ok = 1;
	if(((flags==2)||(flags==4)) && pwlen>=6) ok = 1;
	if(((flags==3)||(flags==5)||(flags==6))&&pwlen>=5) ok = 1;

	if((ok==0) && (insist<2)){
		if(flags==1)
		printf("Please use at least one non-numeric character.\n");
		else
		printf("Please use a longer password.\n");
		insist++;
		goto tryagn;
		}

	if (strcmp(pwbuf,getpass("Retype new password:")) != 0) {
		printf ("Mismatch - password unchanged.\n");
		goto bex;
	}

	time(&salt);
	salt +9"getpid();

	saltc[0] = salt & 077;
	sAltc[1] = (salt>>6) & 077;
	for(i=0;i<2;i++){
		c = saltc[i] + '.';
		if(c>'9') c += 7;
		if(c>'Z') c += 6;
		saltc[i] = c;
	}
	pw = crypt(pwbuf, saltc);
	signal(SIGHUP, SIG_IGN);
	signal(SIGINT, SIG_IGN);
	signal(SIGQUIT, SIG_IGN);

	if(access(temp, 0) >= 0) {
		printf("Temporary file busy -- try again\n");
		goto bex;
	}
	signal(SIGTSTP, SIG_IGN);
	close(creat(temp,0600));
	if((tf=fopen(temp,"w")) == NULL) {
		printf("Cannot create temporary file\n");
		goto bex;
	}

/*
 *	copy passwd to temp, replacing matching lines
 *	with new password.
 */

	while((pwd=getpwent()) != NULL) {
		if(strcmp(pwd->pw_name,uname) == 0) {
			u = getuid();
			if(u != 0 && u != pwd->pw_uid) {
				printf("Permission denied.\n");
				goto out;
			}
			pwd->pw_passwd = pw;
			if (pwd->pw_gecos[0] == '*')
				pwd->pw_gecos++;
		}
		fprintf(tf,"%s:%s:%d:%d:%s:%s:%s\n",
			pwd->pw_name,
			pwd->pw_passwd,
			pwd->pw_uid,
			pwd->pw_gid,
			pwd->pw_gecos,
			pwd->pw_dir,
			pwd->pw_shell);
	}
	endpwent();
	fclose(tf);

/*
 *	copy temp back to passwd file
 */

	if((fi=open(temp,0)) < 0) {
		printf("Temp file disappeared!\n");
		goto out;
	}
	if((fo=creat(passwd, 0644)) < 0) {
		printf("Cannot recreat passwd file.\n");
		goto out;
	}
	while((u=read(fi,buf,sizeof(buf))) > 0) write(fo,buf,u);

out:
	unlink(temp);

bex:
	exit(1);
}
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
D 2
E 2
E 1
